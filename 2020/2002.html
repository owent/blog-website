<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>nftables初体验|I&#39;m OWenT</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=canonical href=//owent.net/2020/2002.html><link href=//owent.net/index.xml rel=alternate type=application/rss+xml title="I'm OWenT"><link rel=icon href=../favicon.ico><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css crossorigin=anonymous><link rel=stylesheet href=//owent.net/css/style.css><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js crossorigin=anonymous></script><link rel=stylesheet href=//owent.net/css/syntax.css></head><body><div id=container><div id=wrap><header id=header><div id=banner></div><div id=header-outer><div id=header-title><h1 id=site-title><a href=//owent.net id=logo>I&#39;m OWenT</a></h1><h2 id=site-description>Challenge Everything</h2></div><div id=header-inner><nav id=main-nav class="navbar navbar-expand-md navbar-dark"><button class="navbar-toggler navbar-toggler-right" type=button data-toggle=collapse data-target=#main-nav-links aria-controls=main-nav-links aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button>
<a id=main-nav-brand class="navbar-brand collapse" href=#>#</a><div class="collapse navbar-collapse" id=main-nav-links><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=../ title=Home>Home</a></li><li class=nav-item><a class=nav-link href=../archives.html title=Archives>Archives</a></li><li class=nav-item><a class=nav-link href=../about.html title=About>About</a></li><li class=nav-item><a id=nav-rss-link class=nav-link href=//owent.net/index.xml title=RSS订阅>RSS订阅</a></li></ul><form class=form-inline method=get accept-charset=utf-8 action=//www.bing.com/search><input type=hidden name=q1 value=site:owent.net>
<input class=form-control type=text placeholder=搜索 name=q>
<button class="btn btn-outline-secondary my-2 my-sm-0" type=submit>搜索</button></form></div></nav></div></div></header><div id=main><section id=main-content><div id=post-content><article id=post-89a323b6d791f0e3745afb1ea4000ec9 class="article-panel article article-type-post" itemscope itemprop=blogPost><div class="article-panel-inner article-inner"><div class=article-inner><header class=article-header><h1 itemprop=name><a class=article-title href=//owent.net/2020/2002.html target=_blank itemprop=url>nftables初体验</a></h1></header><hr><div id=toc class="well toc m-3 p-1 pr-1 pt-1 pb-2 float-md-right"><nav id=TableOfContents><ul><li><ul><li><a href=#前言>前言</a></li><li><a href=#nftables与iptables>nftables与iptables</a></li><li><a href=#nftables与ebtables>nftables与ebtables</a></li><li><a href=#nftables与ipset>nftables与ipset</a></li><li><a href=#nftables与iptables与nat>nftables与iptables与NAT</a></li></ul></li><li><a href=#upper-script-will-disable-auto-load-or-using-scripts-below-to-force-disable-modules>Upper script will disable auto load , or using scripts below to force disable modules</a></li><li><a href=#install-iptable-nat-bin-true>install iptable_nat /bin/true</a></li><li><a href=#install-ip6table-nat-bin-true>install ip6table_nat /bin/true</a></li><li><a href=#这里-br0是我自己建的用于内网通信的桥接-添加了enp5s0和enp1s0f0-enp1s0f1是我用来调试的接口-wan口的出口留了两个用于拨号-enp1s0f2-和-enp1s0f3>这里 br0是我自己建的用于内网通信的桥接，添加了enp5s0和enp1s0f0 。 enp1s0f1是我用来调试的接口， WAN口的出口留了两个用于拨号， enp1s0f2 和 enp1s0f3</a></li><li><a href=#internal-services-begin>Internal services &ndash; begin</a></li><li><a href=#其他自定义要放过的服务端口>其他自定义要放过的服务端口</a></li><li><a href=#internal-services-end>Internal services &ndash; end</a></li><li><a href=#这里-br0是我自己建的用于内网通信的桥接-添加了enp5s0和enp1s0f0-enp1s0f1是我用来调试的接口-wan口的出口留了两个用于拨号-enp1s0f2-和-enp1s0f3-1>这里 br0是我自己建的用于内网通信的桥接，添加了enp5s0和enp1s0f0 。 enp1s0f1是我用来调试的接口， WAN口的出口留了两个用于拨号， enp1s0f2 和 enp1s0f3</a><ul><li><a href=#备注小记>备注小记</a><ul><li><a href=#nftables-hook>nftables Hook</a></li><li><a href=#standard-priority-names-family-and-hook-compatibility-matrix>Standard priority names, family and hook compatibility matrix</a></li><li><a href=#standard-priority-names-and-hook-compatibility-for-the-bridge-family>Standard priority names and hook compatibility for the bridge family</a></li></ul></li></ul></li></ul></nav></div><br><div class=article-entry itemprop=articleBody><h2 id=前言>前言</h2><p>之前一直耳闻 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 是下一代 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 。前段时间配了一台主机，折腾成家里的软路由。就一并来尝鲜一系列新东西，其中就包括 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 。<a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 和 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 、<a href=http://ebtables.netfilter.org/ target=_blank>ebtables</a> 等一样，都是对底层 xtables 的封装，目前看来 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 比 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 更简洁易用，更易读，更容易理解，扩展性和也更好。但是目前各个发行版中对 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 的支持还比较参差不齐，导致 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 很多功能比 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 还是有所缺失，所以个人感觉短期内还是替代不了 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> （比如 tproxy 功能需要 linux kernel 4.19+， 而即便是 <a href=https://www.centos.org/ target=_blank>CentOS 8</a> 的内核版本也只是 4.18 ，所以都不支持 ）。 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 所支持的功能列表及所以来的内核版本和内核模块可以在这里找到 <a href=https://wiki.nftables.org/wiki-nftables/index.php/Supported_features_compared_to_xtables target=_blank>https://wiki.nftables.org/wiki-nftables/index.php/Supported_features_compared_to_xtables</a> 。</p><p><a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 的功能分两块，一块是内核支持，这个受限于内核版本。另一部分是用户空间的库和工具。有些发行版会滚动更新内核，但是 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 版本比较低，这时候如果要用就得自己编译。<a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 依赖库及命令行工具的代码仓库如下:</p><ul><li>libmnl: <a href=http://git.netfilter.org/libmnl/ target=_blank>http://git.netfilter.org/libmnl/</a><br></li><li>libnftnl: <a href=http://git.netfilter.org/libnftnl/ target=_blank>http://git.netfilter.org/libnftnl/</a><br></li><li>nftables: <a href=http://git.netfilter.org/nftables/ target=_blank>http://git.netfilter.org/nftables/</a><br><br></li></ul><p>和 <a href=https://podman.io/ target=_blank>podman</a> 一样， <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 的高版本对依赖库的版本也有一定要求，系统自带的不一定符合要求，就得一个一个编译。我写了一个构建脚本: <a href=https://github.com/owent-utils/docker-setup/blob/master/build-nftables.sh target=_blank>https://github.com/owent-utils/docker-setup/blob/master/build-nftables.sh</a> ， 并且实测如果使用 <a href=https://podman.io/ target=_blank>podman</a> 或者 <a href=https://www.docker.com/ target=_blank>docker</a> 的话，可以宿主机编译，然后mount共享给子机也是可以的。</p><p>官方Wiki: <a href=https://wiki.nftables.org target=_blank>https://wiki.nftables.org</a><br>官方文档: <a href=https://www.netfilter.org/projects/nftables/manpage.html target=_blank>https://www.netfilter.org/projects/nftables/manpage.html</a><br>官方文档不是很全，这个文档更完整一些: <a href=https://www.mankier.com/8/nft target=_blank>https://www.mankier.com/8/nft</a></p><h2 id=nftables与iptables>nftables与iptables</h2><p>先贴一张 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 的流程图。</p><p><img src=2002-nf-packet-flow.svg alt=2002-nf-packet-flow.svg></p><p>在这张图表示的流程里 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 比 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 最大的一个区别就是， <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 可以自由创建多个 table， 然后去hook图里的不同阶段（<a href=https://www.mankier.com/8/nft#Chains）。而 target=_blank>https://www.mankier.com/8/nft#Chains）。而</a> <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 仅有默认的 <strong>raw</strong> , <strong>mangle</strong> , <strong>nat</strong> , <strong>filter</strong> 等table， hook了名字一样的阶段。<a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 可以建立多个 table， 多个table的执行顺序是按优先级来的（<a href=https://www.mankier.com/8/nft#Chains target=_blank>https://www.mankier.com/8/nft#Chains</a> 下面的 <strong>Table 6.</strong> 和 <strong>Table 7.</strong> 里有文档）。 其他的规则和流程 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 和 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 是一样的。只是 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 更简单易读一些。</p><p><a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 的基本命令表达式为 <code>nft create/add/delete/list/flush table/chain/rule [ip/ip6/inet/arp/bridge/netdev] [表达式]</code> 。其中 <code>inet</code> 相当于 <code>ip+ip6</code> 。</p><p>表达式主要有两大类，一类是匹配表达式，还有一类是行为表达式，每一类都分很多种而且是多层级的和 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 也差不多。但是 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 有个比较方便的地方是表达式的最后一个参数如果要多个的话，可以用 <code>{ VALUE1, VAULE2 }</code> 来一次写多个。比如我要同时匹配 tcp和udp 协议，可以写成 <code>meta l4proto { tcp, udp }</code> ; 如果我要匹配所有的 ipv6 的源地址是私有地址和回环地址的话可以写成 <code>ip6 saddr {::1/128, fc00::/7, fe80::/10, fd00::/8, ff00::/8}</code> 。</p><p>以下是一些常用命令:</p><table><thead><tr><th align=left><a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a></th><th align=left><a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a></th><th align=left>说明</th></tr></thead><tbody><tr><td align=left><code>iptables -t mangle -L</code></td><td align=left><code>nft list table mangle</code></td><td align=left>显示指定table(mangle)的所有chains</td></tr><tr><td align=left>-</td><td align=left><code>nft list ruleset</code></td><td align=left>显示所有table的所有chains</td></tr><tr><td align=left><code>iptables -t mangle -A V2RAY -j TRACE</code></td><td align=left><code>nft add rule inet mangle V2RAY meta nftrace set 1</code></td><td align=left>跟踪调试包</td></tr><tr><td align=left><code>iptables -t mangle -A V2RAY -j LOG --log-level debug --log-prefix &quot;###LOG PREFIX:&quot;</code></td><td align=left><code>nft add rule inet mangle V2RAY log prefix '&quot;###LOG PREFIX:&quot;' level debug flags all</code></td><td align=left>输出内核日志</td></tr></tbody></table><blockquote><p>上面跟踪调试包流程的时候 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 可以用 <code>nft monitor trace</code> 来查看包的状态流转。具体可参见 Wiki: <a href=https://wiki.nftables.org/wiki-nftables/index.php/Ruleset_debug/tracing target=_blank>https://wiki.nftables.org/wiki-nftables/index.php/Ruleset_debug/tracing</a></p><p>在 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 里有个工具 <strong>iptables-nft</strong> (<code>iptables-translate [iptables参数列表]</code>) 可以用来转换 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 表达式到 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a>表达式。但是我自己实测的不是很全有些地方也有些谬误。</p><h2 id=nftables与ebtables>nftables与ebtables</h2><p>上面的流程图显示来自于桥接的走了另一套状态流转的流程。要控制桥接的流程，传统的做法可以使用 <a href=http://ebtables.netfilter.org/ target=_blank>ebtables</a> 。按文档的说法 （ <a href=https://www.mankier.com/8/ebtables-legacy#Description-Tables target=_blank>https://www.mankier.com/8/ebtables-legacy#Description-Tables</a> ）， 在 BROUTE 链DROP掉包，能阻止桥接来的包走转发规则，从而转走路由规则。 但是在 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 的文档里仅有 <a href=https://www.mankier.com/8/nft#Statements-Payload_Statement target=_blank>https://www.mankier.com/8/nft#Statements-Payload_Statement</a> 里写了个例子改路由。然而我尝试了几次并没有成功。不管我怎么设置，最终还是走了桥接的包转发，并没有走我指定的流转路径（比如转换成tproxy）。另外还看到个文档 （ <a href=https://www.mankier.com/8/ebtables-nft target=_blank>https://www.mankier.com/8/ebtables-nft</a> ） <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 目前还不支持对 BROUTE 的HOOK。所以我自己这里目前还是走的用 <a href=http://ebtables.netfilter.org/ target=_blank>ebtables</a> 。</p><p>个人感觉 <a href=http://ebtables.netfilter.org/ target=_blank>ebtables</a> 使用起来比 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 麻烦一些，很多插件功能不支持，有些规则也有些限制，比如不支持 <a href=https://nftables.org/projects/ipset/index.html target=_blank>ipset</a> 。但是凑合着还算好用吧。</p><blockquote><p>使用 <a href=http://ebtables.netfilter.org/ target=_blank>ebtables</a> 需要开启内核模块: <code>br_netfilter</code></p><p>另外如果要使用网桥包转路由然后走比如tproxy需要增加如下配置:</p><pre><code class=language-bash>echo &quot;
net.ipv4.ip_forward=1
net.ipv4.ip_forward_use_pmtu=1
net.ipv4.conf.all.forwarding=1
net.ipv4.conf.default.forwarding=1
net.ipv6.conf.all.forwarding=1
net.ipv6.conf.default.forwarding=1
# Configures below are used to support tproxy for bridge
net.bridge.bridge-nf-call-arptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0
net.ipv4.conf.all.route_localnet=1
net.ipv4.conf.default.route_localnet=1
&quot; &gt; /etc/sysctl.d/91-forwarding.conf ;
sysctl -p ;
</code></pre><h2 id=nftables与ipset>nftables与ipset</h2><p>我看了一圈文档，似乎是没找到 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 直接访问 <a href=https://nftables.org/projects/ipset/index.html target=_blank>ipset</a> 的方式。按Wiki的说法（ <a href=https://wiki.nftables.org/wiki-nftables/index.php/Moving_from_ipset_to_nftables target=_blank>https://wiki.nftables.org/wiki-nftables/index.php/Moving_from_ipset_to_nftables</a> ） 是可以用 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 内置的set功能来代替。不过现有的一些工具之集成了对 <a href=https://nftables.org/projects/ipset/index.html target=_blank>ipset</a> 的支持没有支持 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 的set的就得另想办法了。</p><p>对于 <a href=https://nftables.org/projects/ipset/index.html target=_blank>ipset</a> 的 skbinfo插件的功能，可以用 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 的map功能来代替。功能差不太多，个人觉得 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 的更好用一些。</p><h2 id=nftables与iptables与nat>nftables与iptables与NAT</h2><p>按 Wiki 里的说法 （ <a href=https://wiki.nftables.org/wiki-nftables/index.php/Performing_Network_Address_Translation_(NAT)#Incompatibilities target=_blank>https://wiki.nftables.org/wiki-nftables/index.php/Performing_Network_Address_Translation_(NAT)#Incompatibilities</a> ） 。要使用 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 来做 NAT 就要关闭 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 的NAT。即不能载入 <code>iptable_nat</code> 和 <code>ip6table_nat</code> 。但是我自己这边使用的时候，这两个模块被其他的模块拉起了，也是能正常NAT的。不过我并没有用 <a href=https://nftables.org/projects/iptables/index.html target=_blank>iptables</a> 配置任何NAT规则。要彻底屏蔽这两个内核模块并且禁止其他模块拉起可以运行如下脚本:</p><p>```bash<br>echo &ldquo;## Do not load the iptable_nat,ip_tables,ip6table_nat,ip6_tables module on boot.<br>blacklist iptable_nat<br>blacklist ip6table_nat</p></blockquote></blockquote><h1 id=upper-script-will-disable-auto-load-or-using-scripts-below-to-force-disable-modules>Upper script will disable auto load , or using scripts below to force disable modules</h1><h1 id=install-iptable-nat-bin-true>install iptable_nat /bin/true</h1><h1 id=install-ip6table-nat-bin-true>install ip6table_nat /bin/true</h1><p>&rdquo; | tee /etc/modprobe.d/disable-iptables.conf</p><pre><code>
另外我本地为了支持NAT和一些辅助功能开启的模块如下:

</code></pre><p>bash<br>xt_nat<br>nf_reject_ipv4<br>nf_reject_ipv6<br>nf_tables_set<br>nf_log_ipv6<br>nf_log_ipv4<br>nf_log_common<br>nf_tables<br>nfnetlink<br>nf_nat<br>nf_conntrack<br>nf_defrag_ipv6<br>nf_defrag_ipv4<br>nft_log<br>nft_masq<br>nft_ct<br>nft_meta_bridge<br>nft_counter<br>nft_reject<br>nft_reject_inet<br>nft_reject_bridge<br>nft_chain_nat<br>nft_nat</p><pre><code>
nftables与firewalld
----------------------------------------------

我之前一直有用 [firewalld][11] 来操作防火墙。但是当把 [firewalld][11] 的后端设为 [nftables][2] 以后。我发现我自己加的规则老被它刷掉。所以最后我关掉了 [firewalld][11] 并且抄了一份它的默认配置如下:

</code></pre><p>bash<br>nft list table inet security_firewall &gt; /dev/null 2&gt;&amp;1 ;<br>if [ $? -eq 0 ]; then</p><pre><code>nft delete table inet security_firewall ;
</code></pre><p>fi<br>nft add table inet security_firewall ;</p><p>nft add table inet security_firewall ;</p><p>nft add chain inet security_firewall PREROUTING { type filter hook prerouting priority raw + 10\; policy accept\; }<br>nft add rule inet security_firewall PREROUTING icmpv6 type { nd-router-advert, nd-neighbor-solicit } accept ;<br>nft add rule inet security_firewall PREROUTING meta nfproto ipv6 fib saddr . iif oif missing drop ;</p><p>nft add chain inet security_firewall INPUT { type filter hook input priority filter + 10\; policy accept\; }<br>nft add rule inet security_firewall INPUT ct state { established, related } accept<br>nft add rule inet security_firewall INPUT ct status dnat accept</p><h1 id=这里-br0是我自己建的用于内网通信的桥接-添加了enp5s0和enp1s0f0-enp1s0f1是我用来调试的接口-wan口的出口留了两个用于拨号-enp1s0f2-和-enp1s0f3>这里 br0是我自己建的用于内网通信的桥接，添加了enp5s0和enp1s0f0 。 enp1s0f1是我用来调试的接口， WAN口的出口留了两个用于拨号， enp1s0f2 和 enp1s0f3</h1><p>nft add rule inet security_firewall INPUT iifname { lo, br0, enp1s0f0, enp1s0f1, enp5s0 } accept</p><h1 id=internal-services-begin>Internal services &ndash; begin</h1><p>nft add rule inet security_firewall INPUT ip saddr {127.0.0.<sup>1</sup>&frasl;<sub>32</sub>, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8} tcp dport 22 ct state { new, untracked } accept<br>nft add rule inet security_firewall INPUT ip6 saddr {::<sup>1</sup>&frasl;<sub>128</sub>, fc00::/7, fe80::/10, fd00::/8, ff00::/8} tcp dport 22 ct state { new, untracked } accept<br>nft add rule inet security_firewall INPUT ip6 daddr fe80::/64 udp dport 546 ct state { new, untracked } accept<br>nft add rule inet security_firewall INPUT tcp dport 53 ct state { new, untracked } accept<br>nft add rule inet security_firewall INPUT udp dport 53 ct state { new, untracked } accept<br>nft add rule inet security_firewall INPUT udp dport 67 ct state { new, untracked } accept<br>nft add rule inet security_firewall INPUT udp dport 547 ct state { new, untracked } accept<br>nft add rule inet security_firewall INPUT tcp dport 853 ct state { new, untracked } accept</p><h1 id=其他自定义要放过的服务端口>其他自定义要放过的服务端口</h1><h1 id=internal-services-end>Internal services &ndash; end</h1><p>nft add rule inet security_firewall INPUT meta l4proto { icmp, ipv6-icmp } accept<br>nft add rule inet security_firewall INPUT ct state { invalid } drop<br>nft add rule inet security_firewall INPUT reject with icmpx type admin-prohibited</p><p>nft add chain inet security_firewall OUTPUT { type filter hook output priority filter + 10\; policy accept\; }<br>nft add rule inet security_firewall OUTPUT oifname &ldquo;lo&rdquo; accept<br>nft add rule inet security_firewall OUTPUT ip6 daddr { ::/96, ::ffff:0.0.0.0/96, 2002::/24, 2002:a00::/24, 2002:7f00::/24, 2002:a9fe::/32, 2002:ac10::/28, 2002:c0a8::/32, 2002:e000::/19 } reject with icmpv6 type addr-unreachable</p><p>nft add chain inet security_firewall FORWARD { type filter hook forward priority filter + 10\; policy accept\; }<br>nft add rule inet security_firewall FORWARD ct state { established, related } accept<br>nft add rule inet security_firewall FORWARD ct status dnat accept</p><h1 id=这里-br0是我自己建的用于内网通信的桥接-添加了enp5s0和enp1s0f0-enp1s0f1是我用来调试的接口-wan口的出口留了两个用于拨号-enp1s0f2-和-enp1s0f3-1>这里 br0是我自己建的用于内网通信的桥接，添加了enp5s0和enp1s0f0 。 enp1s0f1是我用来调试的接口， WAN口的出口留了两个用于拨号， enp1s0f2 和 enp1s0f3</h1><p>nft add rule inet security_firewall FORWARD iifname { lo, br0, enp1s0f0, enp1s0f1, enp5s0 } accept<br>nft add rule inet security_firewall FORWARD ip6 daddr { ::/96, ::ffff:0.0.0.0/96, 2002::/24, 2002:a00::/24, 2002:7f00::/24, 2002:a9fe::/32, 2002:ac10::/28, 2002:c0a8::/32, 2002:e000::/19 } reject with icmpv6 type addr-unreachable<br>#<br>nft add rule inet security_firewall FORWARD meta l4proto { icmp, ipv6-icmp } accept<br>nft add rule inet security_firewall FORWARD ct state { new, untracked } accept<br>#<br>nft add rule inet security_firewall FORWARD ct state { invalid } drop<br>nft add rule inet security_firewall FORWARD reject with icmpx type admin-prohibited</p><p>```</p><h2 id=备注小记>备注小记</h2><p>以下纪录一下我折腾 <a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a> 的过程中留下的一些可以复用的脚本和趟的坑。</p><ol><li>NAT的设置脚本: <a href=https://github.com/owent-utils/docker-setup/blob/master/setup-router/ppp-nat/setup-nat-ssh.sh target=_blank>https://github.com/owent-utils/docker-setup/blob/master/setup-router/ppp-nat/setup-nat-ssh.sh</a><br></li><li>防火墙设置脚本: <a href=https://github.com/owent-utils/docker-setup/blob/master/setup-router/ppp-nat/setup-nft-security.sh target=_blank>https://github.com/owent-utils/docker-setup/blob/master/setup-router/ppp-nat/setup-nft-security.sh</a><br></li><li>pppoe自动加入<a href=https://nftables.org/projects/ipset/index.html target=_blank>ipset</a>和<a href=https://nftables.org/projects/nftables/index.html target=_blank>nftables</a>的set的设置脚本: <a href=https://github.com/owent-utils/docker-setup/blob/master/setup-router/ppp-nat/setup-ppp-route-ipv4.sh target=_blank>https://github.com/owent-utils/docker-setup/blob/master/setup-router/ppp-nat/setup-ppp-route-ipv4.sh</a><br></li><li>要使用 tproxy (透明代理) 和打 <a href=http://man7.org/linux/man-pages/man7/socket.7.html target=_blank>SO_MARK</a> 的设置脚本: <a href=https://github.com/owent-utils/docker-setup/blob/master/setup-router/v2ray/setup-tproxy.nft.sh target=_blank>https://github.com/owent-utils/docker-setup/blob/master/setup-router/v2ray/setup-tproxy.nft.sh</a><br></li><li><a href=https://www.docker.com/ target=_blank>docker</a>/<a href=https://podman.io/ target=_blank>podman</a> 里如果要使用 tproxy (透明代理) 和打 <a href=http://man7.org/linux/man-pages/man7/socket.7.html target=_blank>SO_MARK</a>，需要基于 <a href=http://man7.org/linux/man-pages/man7/capabilities.7.html target=_blank>CAP_NET_ADMIN</a> 权限<br></li><li>要使用 tproxy (透明代理) 需要开启的内核模块: <code>nf_tproxy_ipv4,nf_tproxy_ipv6,nf_socket_ipv4,nf_socket_ipv6,xt_TPROXY,nft_socket,nft_tproxy</code> 。（其中 <code>nft_tproxy</code> 要求 linux kernel 4.19+）<br></li><li>要管理 <a href=http://ebtables.netfilter.org/ target=_blank>ebtables</a> 的 <strong>broute</strong> 链要开启内核模块: <code>br_netfilter</code><br><br></li></ol><h3 id=nftables-hook>nftables Hook</h3><table><thead><tr><th>Type</th><th>Families</th><th>Hooks</th><th>Description</th></tr></thead><tbody><tr><td>filter</td><td>all</td><td>all</td><td>Standard chain type to use in doubt.</td></tr><tr><td>nat</td><td>ip, ip6, inet</td><td>prerouting, input, output, postrouting</td><td>Chains of this type perform Native Address Translation based on conntrack entries. Only the first packet of a connection actually traverses this chain - its rules usually define details of the created conntrack entry (NAT statements for instance).</td></tr><tr><td>route</td><td>ip, ip6</td><td>output</td><td>If a packet has traversed a chain of this type and is about to be accepted, a new route lookup is performed if relevant parts of the IP header have changed. This allows to e.g. implement policy routing selectors in nftables.</td></tr></tbody></table><h3 id=standard-priority-names-family-and-hook-compatibility-matrix>Standard priority names, family and hook compatibility matrix</h3><blockquote><p>The priority parameter accepts a signed integer value or a standard priority name which specifies the order in which chains with same hook value are traversed. The ordering is ascending, i.e. lower priority values have precedence over higher ones.</p></blockquote><table><thead><tr><th>Name</th><th>Value</th><th>Families</th><th>Hooks</th></tr></thead><tbody><tr><td>raw</td><td>-300</td><td>ip, ip6, inet</td><td>all</td></tr><tr><td>mangle</td><td>-150</td><td>ip, ip6, inet</td><td>all</td></tr><tr><td>dstnat</td><td>-100</td><td>ip, ip6, inet</td><td>prerouting</td></tr><tr><td>filter</td><td>0</td><td>ip, ip6, inet, arp, netdev</td><td>all</td></tr><tr><td>security</td><td>50</td><td>ip, ip6, inet</td><td>all</td></tr><tr><td>srcnat</td><td>100</td><td>ip, ip6, inet</td><td>postrouting</td></tr></tbody></table><h3 id=standard-priority-names-and-hook-compatibility-for-the-bridge-family>Standard priority names and hook compatibility for the bridge family</h3><table><thead><tr><th>Name</th><th>Value</th><th>Hooks</th></tr></thead><tbody><tr><td>dstnat</td><td>-300</td><td>prerouting</td></tr><tr><td>filter</td><td>-200</td><td>all</td></tr><tr><td>out</td><td>100</td><td>output</td></tr><tr><td>srcnat</td><td>300</td><td>postrouting</td></tr></tbody></table></div><hr><footer class=article-footer><div class="article-panel-footer article-meta article-footer"><span class=article-meta-left><ol><li><a href=//owent.net/categories/article.html>Article</a></li><li><a href=//owent.net/categories/blablabla.html>Blablabla</a></li></ol></span><span class=article-meta-right><time datetime=2020-02-10T17:12:00.000&#43;00:00 itemprop=datePublished>2020-02-10</time></span>
<span class=clearfix></span></div><div class=article-tags><ul class=article-tag-list><li class=article-tag-list-item><a href=//owent.net/tags/nftables.html>nftables</a></li><li class=article-tag-list-item><a href=//owent.net/tags/nft.html>nft</a></li><li class=article-tag-list-item><a href=//owent.net/tags/iptables.html>iptables</a></li><li class=article-tag-list-item><a href=//owent.net/tags/ebtables.html>ebtables</a></li><li class=article-tag-list-item><a href=//owent.net/tags/ipset.html>ipset</a></li><li class=article-tag-list-item><a href=//owent.net/tags/nat.html>nat</a></li><li class=article-tag-list-item><a href=//owent.net/tags/docker.html>docker</a></li><li class=article-tag-list-item><a href=//owent.net/tags/podman.html>podman</a></li><li class=article-tag-list-item><a href=//owent.net/tags/firewalld.html>firewalld</a></li></ul></div></footer></div><hr><nav id=article-nav><ul class=pagination><li class=page-item><a class=page-link id=article-nav-older class=article-nav-link-wrap href=//owent.net/2020/2001.html>下一篇<strong>容器配置开发环境小计</strong></a></li></ul></nav><hr><section id=comments><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.identifier='2002';};(function(){var d=document,s=d.createElement('script');s.src='https://owent.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></section></div></article></div></section></div><footer id=footer><div class=outer><div id=footer-info class=inner><strong id=footer-left>&copy; 2020
OWenT</strong>
<strong id=footer-right><a href=https://github.com/owent/blog-hugo target=_blank>本站源码</a>,
发布者 <a href=https://gohugo.io/ target=_blank>Hugo</a>,
主题 <a href=https://github.com/owt5008137/hugo-theme-distinctionpp target=_blank>distinctionpp</a></strong>
<span class=clearfix></span></div></div></footer></div><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/popper.js/1.15.0/umd/popper.min.js crossorigin=anonymous></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js crossorigin=anonymous></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/bash.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/cpp.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/capnproto.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/cmake.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/d.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/diff.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/dos.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/erlang.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/go.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/less.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/lua.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/php.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/powershell.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/protobuf.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/profile.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/typescript.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/vim.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/rust.min.js></script><script type=text/javascript>jQuery(function(){jQuery("head").append('<link rel="stylesheet" href="\/\/cdnjs.cloudflare.com\/ajax\/libs\/highlight.js\/9.15.10\/styles\/vs2015.min.css" />');if(window.JSON){hljs.configure(JSON.parse("{\"languages\":{},\"tabreplace\":\"    \",\"usebr\":false}"));}else{hljs.configure(evel("{\"languages\":{},\"tabreplace\":\"    \",\"usebr\":false}"));}
jQuery('pre\x3ecode').each(function(i,block){try{hljs.highlightBlock(block);}catch(e){if(window.console){console.log(e.toString()+"\r\nMaybe can not detect the language");}}});});</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-19298704-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-19298704-1');</script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js></script><script type=text/javascript>jQuery(function(){jQuery("head").append('<link rel="stylesheet" href="\/\/cdnjs.cloudflare.com\/ajax\/libs\/KaTeX\/0.11.1\/katex.min.css" />');renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\[",right:"\\]",display:true},{left:"\\(",right:"\\)",display:false}],ignoredTags:['script','noscript','style','textarea','pre','code']});});</script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mermaid/8.3.1/mermaid.min.js></script></div></body></html>