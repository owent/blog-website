---
author: owent
categories:
  - Article
  - Blablabla
date: 2019-09-11 19:49:58
draft: true
id: 1909
tags: 
tags: 
  - xresloader
  - xresconv
  - excel
  - json
  - 转表
  - 导表
title: 一些xresloader（转表工具）的改进
type: post
---

前言
------------------------------------------------

最近有几个其他项目组的童鞋给我之前的 [转表工具链-xresloader][1] 提了几个需求。然后我也根据我们近期一些需求点对转表工具链一起给这套工具做了点功能增强和细节上的一些改进。 这篇blog差不多是这些东西的 CHANGELOG了吧。

插件和协议和CI
------------------------------------------------

对一些复杂的需求，使用protobuf插件机制比配置在excel里描述能力要强的多。所以近期大多的新功能都是由插件配置的。但是以前 [转表引擎-xresloader][2] 的发布流程里只包含输出的jar，协议得去对应源码包里找。另外一个童鞋报给我说找 [github][3] 的release里的源码包似乎并不支持git lfs，解出来的git lfs文件只有一个版本号，所以我给CI的发布流程里加了对应版本的protocol文件的打包，当然也包括插件的protocol。

然后顺便也修复了 sample 里的 powershell 脚本，现在有 [powershell-core][4] 的情况下。跨平台脚本反而 [powershell-core][4] 能比较统一了。 原来的是直接bash脚本copy来稍微改了下，兼容性也是有点问题。


转表引擎-xresloader 的新增功能
------------------------------------------------

数字类型转字符串，使用 %g 格式（去除不必要的小数点和0）
常量导出现在会导出protobuf的message里包含oneof了(使用C++的命名规则 k大写驼峰名字 )
支持解析protobuf的内嵌message



增加protobuf插件 - org.xresloader.field_alias 可以设置字段别名并用于配置了验证器的excel数据中
增加protobuf插件 - org.xresloader.enum_alias 可以设置枚举项目的别名并用于配置了验证器的excel数据中
增加protobuf插件 - org.xresloader.field_ratio 可以设置字段放大倍数值，可用于需要转出整数类型的百分率/千分率/万分率，但excel中保留小数表达



批量转表工具之 xresconv-cli 和 xresconv-gui 的新增功能
------------------------------------------------------------------------------------------------

xresconv-cli

    支持多个 ```<output_type></output_type>``` 参数，支持给每个 output_type 单独设置 rename 规则
    优化标准输出和标准错误的输出编码，自动转换 xresloader 的输出编码
    优化 xresloader 的输入编码


xresconv-gui

    支持多个 <output_type></output_type> 参数，支持给每个 output_type 单独设置 rename 规则
    set_name 事件增加 alert_warning(text)/alert_error(text)/log_info(text)/log_error(text) 函数
    set_name 事件增加 work_dir 变量和 configure_file 变量
    on_before_convert/on_after_convert 事件增加 configure_file 变量
    采用Promise重构建立节点树的的流程
    更新依赖库

```json
{
    work_dir: "工作目录(要求版本>=2.2.0)",
    configure_file: "载入的配置文件路径(要求版本>=2.2.0)",
    item_data: {
        id: "条目ID",
        file: "数据源文件",
        scheme: "数据源scheme表名",
        name: "描述名称",
        cat: "分类名称",
        options: ["额外选项"],
        desc: "描述信息",
        scheme_data: {"元数据Key": "元数据Value"}
    },
    alert_warning: function(content, title, options) {},    // (要求版本>=2.2.0) 警告弹框， options 结构是 {yes: 点击是按钮回调, no: 点击否按钮回调, on_close: 关闭后回调}
    alert_error: function(content, title) {},               // (要求版本>=2.2.0) 错误弹框
    log_info: function (content) {},                        // (要求版本>=2.2.0) 打印info日志
    log_error: function (content) {}                        // (要求版本>=2.2.0) 打印info日志
}
```

```json
{
    work_dir: "执行xresloader的工作目录",
    configure_file: "载入的配置文件路径(要求版本>=2.2.0)",
    xresloader_path: "xresloader目录",
    global_options: {"全局选项": "VALUE"},
    selected_nodes: ["选中要执行转表的节点集合"],
    run_seq: "执行序号",
    alert_warning: function(content, title, options) {},    // 警告弹框， options 结构是 {yes: 点击是按钮回调, no: 点击否按钮回调, on_close: 关闭后回调}
    alert_error: function(content, title) {},               // 错误弹框
    log_info: function (content) {},                        // 打印info日志
    log_error: function (content) {},                       // 打印info日志
    resolve: function (value) {},                           // 通知上层执行结束,相当于Promise的resolve
    reject: function(reason) {},                            // 通知上层执行失败,相当于Promise的reject
    require: function (name) {}                             // 相当于 nodejs的 require(name) 用于导入nodejs 模块
}
```

[1]: https://xresloader.atframe.work/
[2]: https://github.com/xresloader/xresloader
[3]: https://github.com
[4]: https://github.com/powershell/powershell
