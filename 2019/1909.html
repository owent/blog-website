<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>一些xresloader（转表工具）的改进|I'm OWenT</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=canonical href=//owent.net/2019/1909.html><link rel=icon href=../favicon.ico><link rel=stylesheet href=//unpkg.com/bootstrap@latest/dist/css/bootstrap.min.css crossorigin=anonymous><link rel=stylesheet href=//owent.net//css/style.css><script type=text/javascript src=//unpkg.com/jquery@latest/dist/jquery.slim.min.js crossorigin=anonymous></script><link rel=stylesheet href=//owent.net/css/syntax.css></head><body><div id=container><div id=wrap><header id=header><div id=banner></div><div id=header-outer><div id=header-title><h1 id=site-title><a href=//owent.net/ id=logo>I'm OWenT</a></h1><h2 id=site-description>Challenge Everything</h2></div><div id=header-inner><nav id=main-nav class="navbar navbar-expand-md navbar-dark"><button class="navbar-toggler navbar-toggler-right" type=button data-toggle=collapse data-target=#main-nav-links aria-controls=main-nav-links aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<a id=main-nav-brand class="navbar-brand collapse" href=#>#</a><div class="collapse navbar-collapse position-relative" id=main-nav-links><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=../ title=Home>Home</a></li><li class=nav-item><a class=nav-link href=../archives.html title=Archives>Archives</a></li><li class=nav-item><a class=nav-link href=../about.html title=About>About</a></li></ul><div class="col-2 position-absolute end-0"><form class=input-group method=get accept-charset=UTF-8 action=//www.bing.com/search><input type=hidden name=q1 value=site:owent.net>
<input class=form-control type=text placeholder=搜索 name=q>
<button class="btn btn-outline-secondary my-2 my-sm-0" type=submit>搜索</button></form></div></div></nav></div></div></header><div id=main><section id=main-content><div id=post-content><article id=post-101338e4d5b2f435c36cab213b68be71 class="article-panel article article-type-post" itemscope itemprop=blogPost><div class="article-panel-inner article-inner"><div class=article-inner><header class=article-header><h1 itemprop=name><a class=article-title href=//owent.net/2019/1909.html target=_blank itemprop=url>一些xresloader（转表工具）的改进</a></h1></header><hr><div id=toc class="well toc m-3 p-1 pr-1 pt-1 pb-2 float-md-right float-md-end"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#插件和协议和ci>插件和协议和CI</a></li><li><a href=#转表引擎-xresloader-的新增功能>转表引擎-xresloader 的新增功能</a></li><li><a href=#批量转表工具之-xresconv-cli-和-xresconv-gui-的新增功能>批量转表工具之 xresconv-cli 和 xresconv-gui 的新增功能</a><ul><li><a href=#xresconv-cli>xresconv-cli</a></li><li><a href=#xresconv-gui>xresconv-gui</a></li></ul></li></ul></nav></div><br><div class=article-entry itemprop=articleBody><h2 id=前言>前言</h2><p>最近有几个其他项目组的童鞋给我之前的 <a href=https://xresloader.atframe.work/>转表工具链-xresloader</a> 提了几个需求。然后我也根据我们近期一些需求点对转表工具链一起给这套工具做了点功能增强和细节上的一些改进。 这篇blog差不多是这些东西的 CHANGELOG了吧。</p><h2 id=插件和协议和ci>插件和协议和CI</h2><p>对一些复杂的需求，使用protobuf插件机制比配置在excel里描述能力要强的多。所以近期大多的新功能都是由插件配置的。但是以前 <a href=https://github.com/xresloader/xresloader>转表引擎-xresloader</a> 的发布流程里只包含输出的jar，协议得去对应源码包里找。另外一个童鞋报给我说找 <a href=https://github.com/>github</a> 的release里的源码包似乎并不支持git lfs，解出来的git lfs文件只有一个版本号，所以我给CI的发布流程里加了对应版本的protocol文件的打包，当然也包括插件的protocol。</p><p>然后顺便也修复了 sample 里的 powershell 脚本，现在有 <a href=https://github.com/powershell/powershell>powershell-core</a> 的情况下。跨平台脚本反而 <a href=https://github.com/powershell/powershell>powershell-core</a> 能比较统一了。 原来的是直接bash脚本copy来稍微改了下，兼容性也是有点问题。</p><h2 id=转表引擎-xresloader-的新增功能>转表引擎-xresloader 的新增功能</h2><ul><li>数字类型转字符串，使用 %g 格式（去除不必要的小数点和0）</li></ul><p>这个主要是之前如果Excel里配置了数值类型，而协议里配置的是文本的话，由于Excel里接口读取出来只有浮点类型，对0而言，直接的同String接口会返回 0.0 。所以就对浮点数值转字符串特别处理了下。让它不再写出无用的后缀。</p><ul><li>常量导出现在会导出protobuf的message里包含oneof了 (使用C++的命名规则 k大写驼峰名字)</li></ul><p>我们自己的项目里现在会使用oneof做一些优化，然后偶尔也会使用一些内嵌的美剧类型。原先常量到处功能导出的枚举和oneof只导出了file层面的枚举，并没有导出oneof。为了方便我们客户端lua层和Web的GM工具的js方便访问，加入了这个内嵌message的oneof和枚举的常量导出。由于oneof没有官方的名称接口，所以我这里导出用了C++里的命名规则了。</p><ul><li>支持解析protobuf的内嵌message</li></ul><p>这个是和上面的一起的，然后协议映射也支持配置成内置message了。这个是顺便做的估计没啥需求。</p><ul><li>增加protobuf插件 - org.xresloader.field_alias 可以设置字段别名并用于配置了验证器的excel数据中</li></ul><p>这条是其他项目组提的需求，他们希望直接excel里配中文名，但是转表的时候转回枚举类型对应的整数。但是不希望走macro表，因为这样就会把很多枚举的内容混在一起。这个需求我们以前的解决方案是直接配字段的名字（ 文档： <a href=https://xresloader.atframe.work/zh_CN/latest/users/advance_usage.html#id4>https://xresloader.atframe.work/zh_CN/latest/users/advance_usage.html#id4</a> ），这个中文别名的功能之前没想到什么维护方便和自动化程度高的方式。也是因为那时候 <a href=https://github.com/xresloader/xresloader>xresloader</a> 还没有支持protobuf的插件扩展。现在可以通过protobuf插件机制支持了。但是也是得使用方导入 <a href=https://github.com/xresloader/xresloader>xresloader</a> 的插件proto 。</p><ul><li>增加protobuf插件 - org.xresloader.enum_alias 可以设置枚举项目的别名并用于配置了验证器的excel数据中</li></ul><p>这条和上面一样，只是上面那条是针对message里的field的，这个是针对enum的。</p><ul><li>增加protobuf插件 - org.xresloader.field_ratio 可以设置字段放大倍数值，可用于需要转出整数类型的百分率/千分率/万分率，但excel中保留小数表达</li></ul><p>这条是起源于我们项目组的一个需求，就是方便策划配表。我们战斗引擎里是不都是整数，没有浮点数，但是又希望方便策划配置千分率的时候对于 35% 可以配置成 0.35 。但是转出千分率的时候导出 350， 现在这里 字段上配置 org.xresloader.field_ratio 就行了。</p><h2 id=批量转表工具之-xresconv-cli-和-xresconv-gui-的新增功能>批量转表工具之 xresconv-cli 和 xresconv-gui 的新增功能</h2><h3 id=xresconv-cli>xresconv-cli</h3><ol><li>支持多个 <code>&lt;output_type>&lt;/output_type></code> 参数，支持给每个 output_type 单独设置 rename 规则；</li></ol><blockquote><p>这也是其他项目组提的一个需求，他们是希望转出程序的二进制的同时可以直接也输出一个其他格式的可读的文本配置。本来是想加到 <a href=https://github.com/xresloader/xresloader>xresloader</a> 里，可能还可以复用里面的 AST 的。但是后面想起来没办法复用AST，因为那个和Excel的列映射相关。如果要支持配置多个DataSource，这种情况必然要重建AST。如果流程保持一致的话这两个功能是冲突的。现阶段 <a href=https://github.com/xresloader/xresloader>xresloader</a> 性能还比较好，所以暂时不想为了这一个需求增加代码维护的复杂性。所以加入到批量导表的协议规范里了。</p></blockquote><ol start=2><li>优化标准输出和标准错误的输出编码，自动转换 <a href=https://github.com/xresloader/xresloader>xresloader</a> 的输出编码；</li></ol><blockquote><p>之前试过一些方式让 <a href=https://github.com/xresloader/xresconv-cli>xresconv-cli</a> 去适配各种环境的终端编码，但是python2+python3，linux+macOS+Windows+MinGW+Cmd(cp936)+Cmd(cp65001)+Powershell(GBK)+Powershell(UTF-8)+Powershell-core,总没发现万金油。现在换了一种实现，在python层转一次编码。看看效果吧。</p></blockquote><ol start=3><li>优化 <a href=https://github.com/xresloader/xresloader>xresloader</a> 的输入编码；</li></ol><h3 id=xresconv-gui>xresconv-gui</h3><ol><li>支持多个 <code>&lt;output_type>&lt;/output_type></code> 参数，支持给每个 output_type 单独设置 rename 规则</li></ol><blockquote><p>和上面 <a href=https://github.com/xresloader/xresconv-cli>xresconv-cli</a> 一致的接入</p></blockquote><ol start=2><li>set_name 事件增加 alert_warning(text)/alert_error(text)/log_info(text)/log_error(text) 函数</li><li>set_name 事件增加 work_dir 变量和 configure_file 变量</li><li>on_before_convert/on_after_convert 事件增加 configure_file 变量</li><li>采用Promise重构建立节点树的的流程</li><li>更新依赖库</li></ol><p>为了更方便 <a href=https://github.com/xresloader/xresconv-gui>xresconv-gui</a> 的事件里读取构建信息的数据和控制GUI的log，补了一些函数和事件，现在的各类接口和事件的可用变量描述如下(新增的标记了 <strong>要求版本>=2.2.0</strong> )：</p><p><strong>set_name</strong> 事件数据。</p><pre><code class=language-javascript>{
    work_dir: &quot;工作目录(要求版本&gt;=2.2.0)&quot;,
    configure_file: &quot;载入的配置文件路径(要求版本&gt;=2.2.0)&quot;,
    item_data: {
        id: &quot;条目ID&quot;,
        file: &quot;数据源文件&quot;,
        scheme: &quot;数据源scheme表名&quot;,
        name: &quot;描述名称&quot;,
        cat: &quot;分类名称&quot;,
        options: [&quot;额外选项&quot;],
        desc: &quot;描述信息&quot;,
        scheme_data: {&quot;元数据Key&quot;: &quot;元数据Value&quot;}
    },
    alert_warning: function(content, title, options) {},    // (要求版本&gt;=2.2.0) 警告弹框， options 结构是 {yes: 点击是按钮回调, no: 点击否按钮回调, on_close: 关闭后回调}
    alert_error: function(content, title) {},               // (要求版本&gt;=2.2.0) 错误弹框
    log_info: function (content) {},                        // (要求版本&gt;=2.2.0) 打印info日志
    log_error: function (content) {}                        // (要求版本&gt;=2.2.0) 打印info日志
}
</code></pre><p><strong>on_before_convert/on_after_convert</strong> 事件数据。</p><pre><code class=language-javascript>{
    work_dir: &quot;执行xresloader的工作目录&quot;,
    configure_file: &quot;载入的配置文件路径(要求版本&gt;=2.2.0)&quot;,
    xresloader_path: &quot;xresloader目录&quot;,
    global_options: {&quot;全局选项&quot;: &quot;VALUE&quot;},
    selected_nodes: [&quot;选中要执行转表的节点集合&quot;],
    run_seq: &quot;执行序号&quot;,
    alert_warning: function(content, title, options) {},    // 警告弹框， options 结构是 {yes: 点击是按钮回调, no: 点击否按钮回调, on_close: 关闭后回调}
    alert_error: function(content, title) {},               // 错误弹框
    log_info: function (content) {},                        // 打印info日志
    log_error: function (content) {},                       // 打印info日志
    resolve: function (value) {},                           // 通知上层执行结束,相当于Promise的resolve
    reject: function(reason) {},                            // 通知上层执行失败,相当于Promise的reject
    require: function (name) {}                             // 相当于 nodejs的 require(name) 用于导入nodejs 模块
}
</code></pre></div><hr><footer class=article-footer><div class="article-panel-footer article-meta article-footer clearfix"><span class=article-meta-left><ol><li><a href=//owent.net/categories/article.html>Article</a></li><li><a href=//owent.net/categories/blablabla.html>Blablabla</a></li></ol></span><span class=article-meta-right><time datetime=2019-09-11T19:49:58.000+00:00 itemprop=datePublished>2019-09-11</time></span>
<span class=clearfix></span></div><div class=article-tags><ul class=article-tag-list><li class=article-tag-list-item><a href=//owent.net/tags/xresloader.html>xresloader</a></li><li class=article-tag-list-item><a href=//owent.net/tags/xresconv.html>xresconv</a></li><li class=article-tag-list-item><a href=//owent.net/tags/excel.html>excel</a></li><li class=article-tag-list-item><a href=//owent.net/tags/json.html>json</a></li><li class=article-tag-list-item><a href=//owent.net/tags/%E8%BD%AC%E8%A1%A8.html>转表</a></li><li class=article-tag-list-item><a href=//owent.net/tags/%E5%AF%BC%E8%A1%A8.html>导表</a></li></ul></div></footer></div><hr><nav id=article-nav><ul class=pagination><li class=page-item><a class=page-link id=article-nav-newer class=article-nav-link-wrap href=//owent.net/2019/1910.html>上一篇<strong>尝鲜Github Action</strong></a></li><li class=page-item><a class=page-link id=article-nav-older class=article-nav-link-wrap href=//owent.net/2019/1908.html>下一篇<strong>protobuf、flatbuffer、msgpack 针对小数据包的简单对比</strong></a></li></ul></nav><hr><script src=https://utteranc.es/client.js repo=owent/blog-website issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></article></div></section></div><footer id=footer><div class=outer><div id=footer-info class="inner clearfix"><strong id=footer-left class="float-left float-start"><a rel=license href=https://github.com/owent/blog-hugo/blob/master/LICENSE.md><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png></a>
2024
owent
</strong><strong id=footer-right class="float-right float-end"><a href=https://github.com/owent/blog-hugo target=_blank>本站源码</a>,
发布者 <a href=https://gohugo.io/ target=_blank>Hugo</a>,
主题 <a href=https://github.com/owent/hugo-theme-distinctionpp target=_blank>distinctionpp</a>
</strong><span class=clearfix></span></div></div></footer></div><script type=text/javascript src=//unpkg.com/@popperjs/core@latest/dist/umd/popper.min.js crossorigin=anonymous></script><script type=text/javascript src=//unpkg.com/bootstrap@latest/dist/js/bootstrap.min.js crossorigin=anonymous></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/highlight.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/awk.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/bash.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/cpp.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/capnproto.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/cmake.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/d.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/diff.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/dockerfile.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/dos.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/erlang.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/go.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/less.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/llvm.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/lua.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/php.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/powershell.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/protobuf.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/python.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/profile.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/typescript.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/vim.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/rust.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/yaml.min.js></script><script type=text/javascript>jQuery(function(){jQuery("head").append('<link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@latest/styles/vs2015.min.css" />'),window.JSON?hljs.configure(JSON.parse('{"ignoreunescapedhtml":true,"languages":{},"tabreplace":"    ","throwunescapedhtml":false,"usebr":false}')):hljs.configure(evel('{"ignoreunescapedhtml":true,"languages":{},"tabreplace":"    ","throwunescapedhtml":false,"usebr":false}'));const e={};for(const t of hljs.listLanguages())e[t.toLowerCase()]=!0;jQuery("pre>code").each(function(e,t){try{if(t.className.match(/\bnohighlight\b|\bmermaid\b/i))return;const e=t.className.match(/language-([^\s]+)/i);if(e&&e.length>=2&&hljs.getLanguage(e[1]))hljs.highlightElement(t);else{const e=jQuery(t),n=hljs.highlightAuto(e.text(),hljs.listLanguages());n&&n.value&&(e.html(n.value),e.addClass("hljs"))}}catch(e){window.console&&console.log(e.toString()+`
Maybe can not detect the language`)}})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-19298704-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-19298704-1")</script><script type=text/javascript src=//unpkg.com/katex@latest/dist/katex.min.js></script><script type=text/javascript src=//unpkg.com/katex@latest/dist/contrib/auto-render.min.js></script><script type=text/javascript>jQuery(function(){jQuery("head").append('<link rel="stylesheet" href="//unpkg.com/katex@latest/dist/katex.min.css" />'),renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"$",right:"$",display:!1}],throwOnError:!1,ignoredTags:["script","noscript","style","textarea","pre","code"]})})</script><script type=text/javascript src=//unpkg.com/chart.js@latest/dist/chart.umd.js></script><script type=module>
    import mermaid from "\/\/unpkg.com\/mermaid@latest\/dist\/mermaid.esm.min.mjs";
    const config = {
        theme: 'neutral',
        logLevel: 'fatal',
        securityLevel: 'loose', 
        startOnLoad: true,
        arrowMarkerAbsolute: false,
        

    };
    mermaid.initialize(config);
</script></div></body></html>