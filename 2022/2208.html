<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>填个转表工具 xresloader 去年的坑（数组尾部裁剪）|I'm OWenT</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=canonical href=//owent.net/2022/2208.html><link rel=icon href=../favicon.ico><link rel=stylesheet href=//unpkg.com/bootstrap@latest/dist/css/bootstrap.min.css crossorigin=anonymous><link rel=stylesheet href=//owent.net//css/style.css><link rel=stylesheet href=//owent.net/css/syntax.css><script type=importmap>
{
  "imports": {
    "react": "//unpkg.com/react@latest",
    "react-bootstrap": "//unpkg.com/react-bootstrap@latest",
    "mermaid": "//unpkg.com/mermaid@latest/dist/mermaid.esm.min.mjs",
    "bootstrap": "//unpkg.com/bootstrap@latest/dist/js/bootstrap.esm.min.js",
    "@popperjs/core": "//unpkg.com/@popperjs/core@latest/dist/esm/popper.js"
  }
}
</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8180054975285991" crossorigin=anonymous></script><meta content="codeva-4M5iohb9TW" name=baidu-site-verification></head><body><div id=container><div id=wrap><header id=header><div id=banner></div><div id=header-outer><div id=header-title><h1 id=site-title><a href=//owent.net/ id=logo>I'm OWenT</a></h1><h2 id=site-description>Challenge Everything</h2></div><div id=header-inner><nav id=main-nav class="navbar navbar-expand-md navbar-dark"><button class="navbar-toggler navbar-toggler-right" type=button data-bs-toggle=collapse data-bs-target=#main-nav-links aria-controls=main-nav-links aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<a id=main-nav-brand class="navbar-brand collapse" href=#>#</a><div class="collapse navbar-collapse position-relative" id=main-nav-links><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=../ title=Home>Home</a></li><li class=nav-item><a class=nav-link href=../archives.html title=Archives>Archives</a></li><li class=nav-item><a class=nav-link href=../about.html title=About>About</a></li><li class="nav-item nav-ads ads-placeholder ads-container"><ins class="adsbygoogle ads_menu" style=display:block data-ad-client=ca-pub-8180054975285991 data-ad-slot=4450372783 data-ad-format=auto data-full-width-responsive=true></ins><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{setTimeout(function(){try{(adsbygoogle=window.adsbygoogle||[]).push({})}catch(e){console.log("Load adsbygoogle failed"),console.error(e)}},256)})</script></li></ul><div class="col-12 col-xl-2 col-lg-3 col-md-4" id=main-nav-search><form class=input-group method=get accept-charset=UTF-8 action=//www.bing.com/search><input type=hidden name=q1 value=site:owent.net>
<input class=form-control type=text placeholder=搜索 name=q>
<button class="btn btn-outline-secondary my-0" type=submit>搜索</button></form></div></div></nav></div></div></header><div id=main><section id=main-content><div id=post-content><article id=post-366de544d3a897dea9f2ab8f5ba3cbec class="article-panel article article-type-post" itemscope itemprop=blogPost><div class="article-panel-inner article-inner"><div class=article-inner><header class=article-header><h1 itemprop=name><a class=article-title href=//owent.net/2022/2208.html target=_blank itemprop=url>填个转表工具 xresloader 去年的坑（数组尾部裁剪）</a></h1></header><hr><div id=toc class="well toc m-3 p-1 pr-1 pt-1 pb-2 float-md-right float-md-end"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#为啥会变动大>为啥会变动大？</a></li><li><a href=#额外增加了一个小工具-xresloader-dump-bin2>额外增加了一个小工具 <a href=https://github.com/xresloader/xresloader-dump-bin>xresloader-dump-bin</a></a></li><li><a href=#分离协议子模块>分离协议子模块</a></li><li><a href=#upb和lua读表工具链>Upb和Lua读表工具链</a></li><li><a href=#最后>最后</a></li></ul></nav><div class="ads-placeholder ads-container"><ins class="adsbygoogle ads_toc" style=display:block data-ad-client=ca-pub-8180054975285991 data-ad-slot=1249494377 data-ad-format=auto data-full-width-responsive=true></ins><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{setTimeout(function(){try{(adsbygoogle=window.adsbygoogle||[]).push({})}catch(e){console.log("Load adsbygoogle failed"),console.error(e)}},256)})</script></div></div><br><div class=article-entry itemprop=articleBody><h2 id=前言>前言</h2><p><a href=https://github.com/xresloader/xresloader>xresloader</a> 是一个功能比较全面并且跨平台的Excel导出protobuf、msgpack、xml、lua、json、javascript、UE-Csv、UE-Json等数据格式的工具。
并且整个工具链还包含了基于模板引起生成读表代码的 <a href=https://github.com/xresloader/xres-code-generator>xres-code-generator</a> ，方便产品/策划使用的 <a href=https://github.com/xresloader/xresconv-gui>GUI批量执行工具 - xresconv-gui</a> 和方便CI集成和程序使用的 <a href=https://github.com/xresloader/xresconv-cli>命令行批量执行工具 - xresconv-cli</a>。</p><p>在之前很多项目和小伙伴们的使用过程中都提了一些非常不错的一键和建议，还有一个Feature Request。其中有一项对整体的输出流程变动比较大，所以之前只改了部分输出类型的实现。
这两天抽空完成了剩余的部分。</p><h2 id=为啥会变动大>为啥会变动大？</h2><p>首先，这个需求的功能是，当一个数组在Excel里配置时，如果存在空配置。那么只裁剪末尾的空项，不裁剪前面的。 详情可参见 <a href=https://github.com/xresloader/xresloader/issues/6>https://github.com/xresloader/xresloader/issues/6</a> 。
为什么这个需求会导致比较大的变化呢？<a href=https://github.com/xresloader/xresloader>xresloader</a> 原本支持的模式有两个，一个是裁剪掉所有空项，这样策划配置在Excel里的无效值会被直接过滤掉。
另一个是保留所有的项目，之前我们有个项目是策划用Excel画地图的，这样要保留所有的位置信息。</p><p>这两种模式的共同点就是，他们对于一个元素准备转出的时候，都能只根据自己的数据知道自己需不需要被导出。
而在新的这个需求功能中，自己要不要输出就和后面还没跑到的元素有关。</p><p>另外由于 <a href=https://github.com/xresloader/xresloader>xresloader</a> 支持多种输出模式，每种模式的输出方式不完全一样，同时输入模式我们也有Plain模式(把数组配置在一个Excel单元格中)和标准模式(数组的每一个元素单独配置在一个Excel单元格中)。
比如在 <code>UE-Csv</code> 模式中，为了提高性能，我们采用的是流式的输出方式。那么在这种场景下，首先我们需要把上级结构传递到下一级，既我们转出数组内的某个元素的时候要知道目前数组以输出的数据长度和当前元素的下标(标准模式)。这样我们才能知道前面需要补多少数据。
显然如果是一个Plain模式的数组，我们是不需要补元素的，因为本身只能动态长度。但是我们不能根据当前导出是Plain模式还是标准模式来决定是否走补全流程。因为可能出现message数组，数组本身是标准模式，但是message是Plain模式。这样这个单元格转出是Plain模式的，但仍然要补数据。</p><p>在去年其实我已经实现了大部分结构的调整和输出模式的裁剪尾部空值的支持。但是那些都是结构化数据，比较好处理。而 <code>UE-Csv</code> 这种流式输出的就比较麻烦，这次主要也就是实现了上面提到的方案的执行细节，总算是填完了这个坑。</p><h2 id=额外增加了一个小工具-xresloader-dump-bin2>额外增加了一个小工具 <a href=https://github.com/xresloader/xresloader-dump-bin>xresloader-dump-bin</a></h2><p>在上个月的时候，为了方便调试，我写了个小工具 <a href=https://github.com/xresloader/xresloader-dump-bin>xresloader-dump-bin</a> ，用于把 <a href=https://github.com/xresloader/xresloader>xresloader</a> 输出的协议二进制转换成人类易读的文本。
主要是为了调试方便使用的，因为 <a href=https://github.com/xresloader/xresloader>xresloader</a> 的结构报了一层，里层是 <code>bytes</code> 没法用protobuf官方工具直接简单得可视化看内容。</p><p>这次这个小工具还是用了 <a href=https://www.rust-lang.org/>Rust</a> 语言写。Rust语言确实是很适合写这类小工具，跨平台和交叉编译都非常方便。运行开销非常小，编译完得包也非常小。</p><h2 id=分离协议子模块>分离协议子模块</h2><p>另外我还把 <a href=https://github.com/xresloader/xresloader>xresloader</a> 的协议分离除了单独的仓库（ <a href=https://github.com/xresloader/xresloader-protocol>https://github.com/xresloader/xresloader-protocol</a> ），并作为各个依赖仓库的子模块。
这是因为随着跟多的工具的实现，依赖这个协议的越来越多，分离出来可以更好地管理协议，也不需要仅仅为了更新协议拉主仓库。</p><h2 id=upb和lua读表工具链>Upb和Lua读表工具链</h2><p>最好一个大地改进是读表工具增加了对 <a href=https://github.com/protocolbuffers/upb>upb</a> 和其 Lua binding地支持。 <a href=https://github.com/cloudwu/pbc>pbc</a> 已经被作者弃坑好多年了，所以我们项目组近期接入了这个更有影响力地方案。
<a href=https://github.com/xresloader/xresloader>upb</a> 是一个 protobuf 官方的子项目，运行时使用纯C编写。代码生成工具使用C++，依赖 libprotoc 和 abseil-cpp 。并且 <a href=https://github.com/xresloader/xresloader>upb</a> 是现在protobuf的Ruby, PHP和Python的官方运行时库，里面也包含了Lua binding模块。这样不仅技术支持有保障（有主流项目踩坑），并且能跟进protobuf的新功能。</p><p>简单地说，就是读表代码生成工具 <a href=https://github.com/xresloader/xres-code-generator>xres-code-generator</a> 里增加了支持 <a href=https://github.com/protocolbuffers/upb>upb</a> 和其 Lua binding 的模板和Loader的Service模块。
同时构建系统 <a href=https://github.com/atframework/cmake-toolset>cmake-toolset</a> 里增加了对集中不同引入方式和几个典型版本的upb的适配和Patch，并提供了自测小工具。</p><p>更多细节可以参见我之前一篇Blog: <a href=https://owent.net/2022/2207.html>《集成 upb 和 lua binding 的踩坑小计》</a> 。</p><h2 id=最后>最后</h2><p>其实还有一些其他的小优化的Feature Request，不过那些变动都不大。下次啥时候能抽出时间来再继续加吧。</p><p>欢迎大家试用和提出宝贵意见。</p><p>开源主仓库: <a href=https://github.com/xresloader/xresloader>https://github.com/xresloader/xresloader</a>
文档: <a href=https://xresloader.atframe.work/>https://xresloader.atframe.work/</a></p></div><hr><footer class=article-footer><div class="article-panel-footer article-meta article-footer clearfix"><span class=article-meta-left><ol><li><a href=//owent.net/categories/article.html>Article</a></li><li><a href=//owent.net/categories/blablabla.html>Blablabla</a></li></ol></span><span class=article-meta-right><time datetime=2022-08-27T20:59:45.000+00:00 itemprop=datePublished>2022-08-27</time></span>
<span class=clearfix></span></div><div class=article-tags><ul class=article-tag-list><li class=article-tag-list-item><a href=//owent.net/tags/upb.html>upb</a></li><li class=article-tag-list-item><a href=//owent.net/tags/protobuf.html>protobuf</a></li><li class=article-tag-list-item><a href=//owent.net/tags/lua.html>lua</a></li><li class=article-tag-list-item><a href=//owent.net/tags/excel.html>excel</a></li><li class=article-tag-list-item><a href=//owent.net/tags/xresloader.html>xresloader</a></li><li class=article-tag-list-item><a href=//owent.net/tags/xresloader-dump-bin.html>xresloader-dump-bin</a></li></ul></div></footer><div class="ads-placeholder ads-container"><ins class="adsbygoogle ads_infeed" style=display:block data-ad-client=ca-pub-8180054975285991 data-ad-slot=5599802929 data-ad-format=auto data-full-width-responsive=true></ins><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{setTimeout(function(){try{(adsbygoogle=window.adsbygoogle||[]).push({})}catch(e){console.log("Load adsbygoogle failed"),console.error(e)}},256)})</script></div></div><hr><nav id=article-nav><ul class=pagination><li class=page-item><a class=page-link id=article-nav-newer class=article-nav-link-wrap href=//owent.net/2022/2209.html>上一篇<strong>关于opentelemetry-cpp社区对于C++ Head Only组件单例和符号可见性的讨论小记</strong></a></li><li class=page-item><a class=page-link id=article-nav-older class=article-nav-link-wrap href=//owent.net/2022/2207.html>下一篇<strong>集成 upb 和 lua binding 的踩坑小记</strong></a></li></ul></nav><hr><script src=https://utteranc.es/client.js repo=owent/blog-website issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></article></div></section></div><footer id=footer><div class=outer><div id=footer-info class="inner clearfix"><strong id=footer-left class="float-left float-start"><a rel=license href=https://github.com/owent/blog-hugo/blob/master/LICENSE.md><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png></a>2024&nbsp;owent
</strong><strong id=footer-right class="float-right float-end">沪ICP备2022003252号&nbsp;&nbsp;<a href=https://github.com/owent/blog-hugo target=_blank>本站源码</a>,
发布者 <a href=https://gohugo.io/ target=_blank>Hugo</a>,
主题 <a href=https://github.com/owent/hugo-theme-distinctionpp target=_blank>distinctionpp</a>
</strong><span class=clearfix></span></div></div></footer></div><script type=module>// import * as Popper from "@popperjs/core";// import * as bootstrap from "bootstrap";
// import React from "react";

        
</script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/highlight.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/awk.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/bash.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/cpp.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/capnproto.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/cmake.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/d.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/diff.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/dockerfile.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/dos.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/erlang.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/go.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/less.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/llvm.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/lua.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/php.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/powershell.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/protobuf.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/python.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/profile.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/typescript.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/vim.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/rust.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/yaml.min.js></script><script type=text/javascript>document.addEventListener("DOMContentLoaded",e=>{const t=document.createElement("link");t.rel="stylesheet",t.href="//unpkg.com/@highlightjs/cdn-assets@latest/styles/vs2015.min.css",document.querySelector("head").appendChild(t),window.JSON?hljs.configure(JSON.parse('{"ignoreunescapedhtml":true,"languages":{},"tabreplace":"    ","throwunescapedhtml":false,"usebr":false}')):hljs.configure(evel('{"ignoreunescapedhtml":true,"languages":{},"tabreplace":"    ","throwunescapedhtml":false,"usebr":false}'));const n={};for(const e of hljs.listLanguages())n[e.toLowerCase()]=!0;for(const e of document.querySelectorAll("pre>code"))try{if(e.className.match(/\bmermaid\b/i)){e.classList.add("mermaid");continue}if(e.className.match(/\bnohighlight\b/i))continue;const t=e.className.match(/language-([^\s]+)/i);if(t&&t.length>=2&&hljs.getLanguage(t[1]))hljs.highlightElement(e);else{const t=hljs.highlightAuto(e.innerText,hljs.listLanguages());t&&t.value&&(e.innerHTML=t.value,e.classList.add("hljs"))}}catch(e){window.console&&console.log(e.toString()+`\r
Maybe can not detect the language`)}})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PQEY77BYG1"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PQEY77BYG1")}</script><script type=text/javascript src=//unpkg.com/katex@latest/dist/katex.min.js></script><script type=text/javascript src=//unpkg.com/katex@latest/dist/contrib/auto-render.min.js></script><script type=text/javascript>document.addEventListener("DOMContentLoaded",e=>{const t=document.createElement("link");t.rel="stylesheet",t.href="//unpkg.com/katex@latest/dist/katex.min.css",document.querySelector("head").appendChild(t),renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"$",right:"$",display:!1}],throwOnError:!1,ignoredTags:["script","noscript","style","textarea","pre","code"]})})</script><script type=text/javascript src=//unpkg.com/chart.js@latest/dist/chart.umd.js></script><script type=module>
import mermaid from "mermaid";
const config = {
    theme: 'neutral',
    logLevel: 'fatal',
    securityLevel: 'loose', 
    startOnLoad: true,
    arrowMarkerAbsolute: false,
    

};
mermaid.initialize(config);
</script></div></body></html>