<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>使用ELK辅助监控开发测试环境服务质量和问题定位|I'm OWenT</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=canonical href=//owent.net/2018/1812.html><link rel=icon href=/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css crossorigin=anonymous><link rel=stylesheet href=//owent.net//css/style.css><link rel=stylesheet href=//owent.net/css/syntax.css><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8180054975285991" crossorigin=anonymous></script><meta content="codeva-4M5iohb9TW" name=baidu-site-verification></head><body><div id=container><div id=wrap><header id=header><div id=banner></div><div id=header-outer><div id=header-title><h1 id=site-title><a href=//owent.net/ id=logo>I'm OWenT</a></h1><h2 id=site-description>Challenge Everything</h2></div><div id=header-inner><nav id=main-nav class="navbar navbar-expand-md navbar-dark"><button class="navbar-toggler navbar-toggler-right" type=button data-bs-toggle=collapse data-bs-target=#main-nav-links aria-controls=main-nav-links aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<a id=main-nav-brand class="navbar-brand collapse" href=#>#</a><div class="collapse navbar-collapse position-relative" id=main-nav-links><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/index.html title=Home>Home</a></li><li class=nav-item><a class=nav-link href=/archives/index.html title=Archives>Archives</a></li><li class=nav-item><a class=nav-link href=/about/index.html title=About>About</a></li></ul><div class="col-12 col-xl-2 col-lg-3 col-md-4" id=main-nav-search><form class=input-group method=get accept-charset=UTF-8 action=//www.bing.com/search><input type=hidden name=q1 value=site:owent.net>
<input class=form-control type=text placeholder=搜索 name=q>
<button class="btn btn-outline-secondary my-0" type=submit>搜索</button></form></div></div></nav></div></div></header><div id=main><section id=main-content><div id=post-content><article id=post-11e01cd7bf0256d41ff535c487e2d154 class="article-panel article article-type-post" itemscope itemprop=blogPost><div class="article-panel-inner article-inner"><div class=article-inner><header class=article-header><h1 itemprop=name><a class=article-title href=//owent.net/2018/1812.html target=_blank itemprop=url>使用ELK辅助监控开发测试环境服务质量和问题定位</a></h1></header><hr><div id=toc class="well toc m-3 p-1 pr-1 pt-1 pb-2 float-md-right float-md-end"><nav id=TableOfContents><ul><li><a href=#什么是elk>什么是ELK？</a></li><li><a href=#节点部署>节点部署</a><ul><li><a href=#elasticsearch-集群部署>elasticsearch 集群部署</a></li><li><a href=#logstash-部署>logstash 部署</a></li><li><a href=#kibana-部署>kibana 部署</a></li></ul></li><li><a href=#日志接入>日志接入</a></li><li><a href=#定期清理elasticsearch-curator>定期清理(elasticsearch-curator)</a></li><li><a href=#最后sample>最后Sample</a></li></ul></nav><div class="ads-placeholder ads-container"><ins class="adsbygoogle ads_toc" style=display:block data-ad-client=ca-pub-8180054975285991 data-ad-slot=1249494377 data-ad-format="rectangle, vertical" data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><br><div class=article-entry itemprop=articleBody><h2 id=什么是elk>什么是ELK？</h2><p>ELK 是 <a href=https://www.elastic.co/cn/products/elasticsearch>elasticsearch</a> + <a href=https://www.elastic.co/cn/products/logstash>logstash</a> + <a href=https://www.elastic.co/cn/products/kibana>kibana</a>的缩写。这一套是现在比较流行的日志全文索引系统了。我之前的项目也有用它来做过日志分析，这次主要是拿来搭建开发测试环境的监控和分析系统，顺带记录一下部署脚本和流程。</p><p>其中 <a href=https://www.elastic.co/cn/products/elasticsearch>elasticsearch</a> 是日志索引系统，我按两个master，3个数据和处理节点来部署。 <a href=https://www.elastic.co/cn/products/logstash>logstash</a> 和 <a href=https://www.elastic.co/cn/products/kibana>kibana</a> 因为是开发测试环境使用，量级不大，所以只部署了一个节点。但是在使用过程中发现 <a href=https://www.elastic.co/cn/products/elasticsearch>elasticsearch</a> 在jre的GC的时候还是有较长时间的 <em><strong>Stop The World</strong></em> 的问题，而且这期间的数据会倍丢弃。所以为了缓解这个状况，又引入了 <a href=https://redis.io/>redis</a> 作为消息队列使用。然后使用两组pipeline，一个从 client -> <a href=https://www.elastic.co/cn/products/logstash>logstash</a> -> <a href=https://redis.io/>redis</a> ，另一个从 <a href=https://redis.io/>redis</a> -> <a href=https://www.elastic.co/cn/products/logstash>logstash</a> -> <a href=https://www.elastic.co/cn/products/elasticsearch>elasticsearch</a> 来传输。这样如果在 <a href=https://www.elastic.co/cn/products/elasticsearch>elasticsearch</a> GC的 <em><strong>Stop The World</strong></em> 结束的时候会把数据补回去。 外面更大型的部署也有用 <a href=https://kafka.apache.org/>kafka</a> 或者更进一步优化的 <a href=https://pulsar.apache.org/>pulsar</a>。不过我们目前的应用也不太需要 <a href=https://kafka.apache.org/>kafka</a> 和 <a href=https://pulsar.apache.org/>pulsar</a> 那种数据落地和强一致性，使用 <a href=https://redis.io/>redis</a> 也已经够了。</p><p>后面的脚本都已 6.4.2 为准，因为最后一次更新多节点部署的脚本是基于 6.4.2 的。而且这个版本 x-pack 内置进 <a href=https://www.elastic.co/cn/products/elasticsearch>elasticsearch</a> 了，也能省了 x-pack 的部署和基础版的License。</p><h2 id=节点部署>节点部署</h2><p>首先要准备好部署的包: jdk-8u181-linux-x64.rpm 、 elasticsearch-6.4.2.tar.gz 、 logstash-6.4.2.tar.gz 、 kibana-6.4.2-linux-x86_64.tar.gz 。</p><p>先贴整体结构图，后面的脚本和配置模板比较长。</p><p><img src=1812-01.dot.png alt=1812-01.dot.png></p><h3 id=elasticsearch-集群部署>elasticsearch 集群部署</h3><p>然后是我复制出来的init.d的启动脚本模板 (init.d/elasticsearch.template)</p><pre><code class=language-bash>#!/bin/bash
#
# elasticsearch &lt;summary&gt;
#
# chkconfig:   2345 80 20
# description: Starts and stops a single elasticsearch instance on this system
#

### BEGIN INIT INFO
# Provides: Elasticsearch
# Required-Start: $network $named
# Required-Stop: $network $named
# Default-Start: 2 3 4 5
# Default-Stop: 0 1 6
# Short-Description: This service manages the elasticsearch daemon
# Description: Elasticsearch is a very scalable, schema-free and high-performance search solution supporting multi-tenancy and near realtime search.
### END INIT INFO

#
# init.d / servicectl compatibility (openSUSE)
#
if [ -f /etc/rc.status ]; then
    . /etc/rc.status
    rc_reset
fi

#
# Source function library.
#
if [ -f /etc/rc.d/init.d/functions ]; then
    . /etc/rc.d/init.d/functions
fi

# Sets the default values for elasticsearch variables used in this script
ES_HOME=&quot;%TEMPLATE_VAR_ELK_HOME%/elasticsearch&quot;
MAX_OPEN_FILES=65536
MAX_MAP_COUNT=262144
ES_PATH_CONF=&quot;$ES_HOME/config&quot;

PID_DIR=&quot;%TEMPLATE_VAR_ELK_HOME%/run&quot;

# Source the default env file
ES_ENV_FILE=&quot;/etc/sysconfig/elasticsearch&quot;
if [ -f &quot;$ES_ENV_FILE&quot; ]; then
    . &quot;$ES_ENV_FILE&quot;
fi

# ES_USER and ES_GROUP settings were removed
if [ ! -z &quot;$ES_USER&quot; ] || [ ! -z &quot;$ES_GROUP&quot; ]; then
    echo &quot;ES_USER and ES_GROUP settings are no longer supported. To run as a custom user/group use the archive distribution of Elasticsearch.&quot;
    exit 1
fi

exec=&quot;$ES_HOME/bin/elasticsearch&quot;
prog=&quot;elasticsearch&quot;
pidfile=&quot;$PID_DIR/${prog}.pid&quot;

export ES_JAVA_OPTS
export JAVA_HOME
export ES_PATH_CONF
export ES_STARTUP_SLEEP_TIME
export ES_HEAP_SIZE

lockfile=%TEMPLATE_VAR_ELK_DATA%/lock/$prog.lock

if [ ! -x &quot;$exec&quot; ]; then
    echo &quot;The elasticsearch startup script does not exists or it is not executable, tried: $exec&quot;
    exit 1
fi

checkJava() {
    if [ -x &quot;$JAVA_HOME/bin/java&quot; ]; then
        JAVA=&quot;$JAVA_HOME/bin/java&quot;
    else
        JAVA=`which java`
    fi

    if [ ! -x &quot;$JAVA&quot; ]; then
        echo &quot;Could not find any executable java binary. Please install java in your PATH or set JAVA_HOME&quot;
        exit 1
    fi
}

start() {
    checkJava
    [ -x $exec ] || exit 5

    if [ -n &quot;$MAX_OPEN_FILES&quot; ]; then
        ulimit -n $MAX_OPEN_FILES
    fi
    # if [ -n &quot;$MAX_LOCKED_MEMORY&quot; ]; then
    #     ulimit -l $MAX_LOCKED_MEMORY
    # fi
    if [ -n &quot;$MAX_MAP_COUNT&quot; -a -f /proc/sys/vm/max_map_count ]; then
        sysctl -q -w vm.max_map_count=$MAX_MAP_COUNT
    fi

    # Ensure that the PID_DIR exists (it is cleaned at OS startup time)
    if [ -n &quot;$PID_DIR&quot; ] &amp;&amp; [ ! -e &quot;$PID_DIR&quot; ]; then
        mkdir -p &quot;$PID_DIR&quot; &amp;&amp; chown %TEMPLATE_VAR_ELK_USER%:%TEMPLATE_VAR_ELK_GROUP% &quot;$PID_DIR&quot;
    fi
    if [ -n &quot;$pidfile&quot; ] &amp;&amp; [ ! -e &quot;$pidfile&quot; ]; then
        touch &quot;$pidfile&quot; &amp;&amp; chown %TEMPLATE_VAR_ELK_USER%:%TEMPLATE_VAR_ELK_GROUP% &quot;$pidfile&quot;
    fi

    cd $ES_HOME
    echo -n $&quot;Starting $prog: &quot;
    # if not running, start it up here, usually something like &quot;daemon $exec&quot;
    daemon --user %TEMPLATE_VAR_ELK_USER% --pidfile $pidfile $exec -p $pidfile -d
    retval=$?
    echo
    [ $retval -eq 0 ] &amp;&amp; touch $lockfile
    return $retval
}

stop() {
    echo -n $&quot;Stopping $prog: &quot;
    # stop it here, often &quot;killproc $prog&quot;
    killproc -p $pidfile -d 86400 $prog
    retval=$?
    echo
    [ $retval -eq 0 ] &amp;&amp; rm -f $lockfile
    return $retval
}

restart() {
    stop
    start
}

reload() {
    restart
}

force_reload() {
    restart
}

rh_status() {
    # run checks to determine if the service is running or use generic status
    status -p $pidfile $prog
}

rh_status_q() {
    rh_status &gt;/dev/null 2&gt;&amp;1
}


case &quot;$1&quot; in
    start)
        rh_status_q &amp;&amp; exit 0
        $1
        ;;
    stop)
        rh_status_q || exit 0
        $1
        ;;
    restart)
        $1
        ;;
    reload)
        rh_status_q || exit 7
        $1
        ;;
    force-reload)
        force_reload
        ;;
    status)
        rh_status
        ;;
    condrestart|try-restart)
        rh_status_q || exit 0
        restart
        ;;
    *)
        echo $&quot;Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload}&quot;
        exit 2
esac
exit $?
</code></pre><p>如果是使用systemd的话就不需要上面那个，要另外写个守护服务配置模板和环境配置模板 (sysconfig/elasticsearch.template):</p><pre><code class=language-bash>################################
# Elasticsearch
################################

ES_HEAP_SIZE=%TEMPLATE_VAR_ELK_ELASTICSEARCH_USE_MEMORY%

# Elasticsearch home directory
ES_HOME=%TEMPLATE_VAR_ELK_HOME%/elasticsearch

# Elasticsearch Java path
#JAVA_HOME=

# Elasticsearch configuration directory
ES_PATH_CONF=%TEMPLATE_VAR_ELK_HOME%/elasticsearch/config

# Elasticsearch PID directory
PID_DIR=%TEMPLATE_VAR_ELK_HOME%/run

# Additional Java OPTS
#ES_JAVA_OPTS=

# Configure restart on package upgrade (true, every other setting will lead to not restarting)
#RESTART_ON_UPGRADE=true

################################
# Elasticsearch service
################################

# SysV init.d
#
# The number of seconds to wait before checking if Elasticsearch started successfully as a daemon process
ES_STARTUP_SLEEP_TIME=%TEMPLATE_VAR_ELK_STARTUP_SLEEP%

################################
# System properties
################################

# Specifies the maximum file descriptor number that can be opened by this process
# When using Systemd, this setting is ignored and the LimitNOFILE defined in
# /usr/lib/systemd/system/elasticsearch.service takes precedence
#MAX_OPEN_FILES=65536

# The maximum number of bytes of memory that may be locked into RAM
# Set to &quot;unlimited&quot; if you use the 'bootstrap.memory_lock: true' option
# in elasticsearch.yml.
# When using systemd, LimitMEMLOCK must be set in a unit file such as
# /etc/systemd/system/elasticsearch.service.d/override.conf.
#MAX_LOCKED_MEMORY=unlimited

# Maximum number of VMA (Virtual Memory Areas) a process can own
# When using Systemd, this setting is ignored and the 'vm.max_map_count'
# property is set at boot time in /usr/lib/sysctl.d/elasticsearch.conf
#MAX_MAP_COUNT=262144
</code></pre><p><a href=https://www.elastic.co/cn/products/elasticsearch>elasticsearch</a> 的部署脚本分几个文件，其中配置文件(deploy-conf.sh)如下(里面也包含了一下依赖包):</p><pre><code class=language-bash>#!/bin/bash

USER=执行用户;
GROUP=执行组;

ELK_CLUSTER_NAME=&quot;集群名称&quot; ;
ELK_CLUSTER_MASTER=(&quot;主节点1-IP&quot; &quot;主节点2-IP&quot;) ;
ELK_CLUSTER_PASSWORD=&quot;集群密码&quot;
ELK_ELASTICSEARCH_PKG_NAME=&quot;elasticsearch-6.4.2&quot;;
ELK_ELASTICSEARCH_PORT=9200;
ELK_ELASTICSEARCH_SLEEP_SEC=5;

JAVA_JDK_RPM=jdk-8u181-linux-x64.rpm ;

DATA_DIR=$(df -h | grep &quot;\\/data&quot; | awk '{print $6}');   # 数据盘挂在 /data*
HOME_DIR=$(cat /etc/passwd | grep $USER | cut -d: -f 6);
ELK_HOME_DIR=&quot;$HOME_DIR/elk&quot;;
ELK_DATA_DIR=&quot;$DATA_DIR/elk&quot;;

function is_elk_master() {
    for host_node in ${ELK_CLUSTER_MASTER[@]}; do
        if [ &quot;$1&quot; == &quot;$host_node&quot; ]; then
            echo &quot;true&quot;;
            return;
        fi
    done
    echo &quot;false&quot;;
}

function get_discovery_unicast() {
    RET=&quot;&quot;;
    for host in ${ELK_CLUSTER_MASTER[@]}; do
        if [ -z &quot;$RET&quot; ]; then
            RET=&quot;\&quot;$host\&quot;&quot;;
        else
            RET=&quot;$RET, \&quot;$host\&quot;&quot;;
        fi
    done

    echo &quot;[$RET]&quot;;
}

function wait_for_elasticsearch_startup() {
    ELK_ELASTICSEARCH_WAIT_SEC=$(($ELK_ELASTICSEARCH_SLEEP_SEC+5));
    printf &quot;Wait for elasticsearch startup ($ELK_ELASTICSEARCH_WAIT_SEC seconds) &quot;;
    for ((i=0;i&lt;$ELK_ELASTICSEARCH_WAIT_SEC;++i)); do
        printf &quot;.&quot;;
        sleep 1;
    done
    echo &quot;&quot;;
}
</code></pre><p>然后是部署机用的脚本(deploy-remote.sh)，这个脚本每个机器IP执行一次，要确保有权限:</p><pre><code class=language-bash>#!/bin/bash

if [ $# -lt 2 ]; then
    echo &quot;Usage: $0 &lt;ip&gt; &lt;use memory&gt;&quot;;
    exit 1;
fi

REMOTE_IP=$1;
USE_MEMORY=$2;

ssh 用户名@$REMOTE_IP &quot;echo \&quot;PWD=\$PWD\&quot; &amp;&amp; echo \&quot;HOME=\$HOME\&quot; &amp;&amp; mkdir -p \$HOME/elk&quot;;
scp jdk-8u181-linux-x64.rpm *.tar.gz *.sh init.d sysconfig &quot;用户名@$REMOTE_IP:/HOME目录/elk/&quot;;

ssh owentou@$REMOTE_IP &quot;echo \&quot;PWD=\$PWD\&quot; &amp;&amp; echo \&quot;HOME=\$HOME\&quot; &amp;&amp; cd \$HOME/elk &amp;&amp; chmod +x *.sh &amp;&amp; sudo ./deploy.sh $REMOTE_IP $USE_MEMORY&quot;;
</code></pre><p>然后是目标机上执行的脚本(deploy.sh)，要注意防火墙要额外开一下:</p><pre><code class=language-bash>#!/bin/bash

export PATH=$PATH:/sbin;

if [ $# -lt 2 ]; then
    echo &quot;Usage: $0 &lt;ip&gt; &lt;use memory&gt;&quot;;
    exit 1;
fi

BIND_IP=$1;
USE_MEMORY=$2;

SCRIPT_DIR=&quot;$(cd $(dirname $0) &amp;&amp; pwd)&quot;;
source &quot;$SCRIPT_DIR/deploy-conf.sh&quot;;

mkdir -p $ELK_DATA_DIR/lock;
mkdir -p $ELK_DATA_DIR/elasticsearch/data;
mkdir -p $ELK_DATA_DIR/elasticsearch/logs;
mkdir -p $ELK_DATA_DIR/dump/data;
mkdir -p $ELK_DATA_DIR/dump/logs;

mkdir -p $ELK_HOME_DIR/lock;
mkdir -p $ELK_HOME_DIR/run;

# ====================== install java8 ======================
rpm -Uvh $SCRIPT_DIR/$JAVA_JDK_RPM;
if [ 0 -ne $? ]; then
    rpm -ivh $SCRIPT_DIR/$JAVA_JDK_RPM;
fi

alternatives --auto java 2&gt;&amp;1;
alternatives --display java 2&gt;&amp;1;
# alternatives --config java 2&gt;&amp;1;

# ====================== unpack elasticsearch ======================
cd &quot;$ELK_HOME_DIR&quot;;

if [ ! -e &quot;$ELK_ELASTICSEARCH_PKG_NAME&quot; ]; then
    tar -axvf &quot;$SCRIPT_DIR/$ELK_ELASTICSEARCH_PKG_NAME.tar.gz&quot;;
fi

if [ -e elasticsearch ] &amp;&amp; [ -e &quot;$PWD/$ELK_ELASTICSEARCH_PKG_NAME&quot; ]; then
    rm -f elasticsearch;
fi
ln -sf &quot;$PWD/$ELK_ELASTICSEARCH_PKG_NAME&quot; elasticsearch;

# ====================== setup scripts ======================
# TEMPLATE_VAR_ELK_HOME, TEMPLATE_VAR_ELK_ELASTICSEARCH_USE_MEMORY, TEMPLATE_VAR_ELK_STARTUP_SLEEP, TEMPLATE_VAR_ELK_DATA, TEMPLATE_VAR_ELK_USER, TEMPLATE_VAR_ELK_GROUP
cp -f &quot;$SCRIPT_DIR/init.d/elasticsearch.template&quot; /etc/init.d/elasticsearch;   # ************ 如果使用systemd的话这里换成systemd的模板 ************
cp -f &quot;$SCRIPT_DIR/sysconfig/elasticsearch.template&quot; /etc/sysconfig/elasticsearch;

perl -p -i -e &quot;s;\\%TEMPLATE_VAR_ELK_ELASTICSEARCH_USE_MEMORY\\%;$USE_MEMORY;g&quot; /etc/sysconfig/elasticsearch;
perl -p -i -e &quot;s;\\%TEMPLATE_VAR_ELK_HOME\\%;$ELK_HOME_DIR;g&quot; /etc/sysconfig/elasticsearch;
perl -p -i -e &quot;s;\\%TEMPLATE_VAR_ELK_STARTUP_SLEEP\\%;$ELK_ELASTICSEARCH_SLEEP_SEC;g&quot; /etc/sysconfig/elasticsearch;

if [ -e /etc/sysconfig/elasticsearch.bak ]; then
    rm -f /etc/sysconfig/elasticsearch.bak;
fi

# ************ 如果使用systemd的话这里换成systemd的模板 ************
perl -p -i -e &quot;s;\\%TEMPLATE_VAR_ELK_HOME\\%;$ELK_HOME_DIR;g&quot; /etc/init.d/elasticsearch;
perl -p -i -e &quot;s;\\%TEMPLATE_VAR_ELK_DATA\\%;$ELK_DATA_DIR;g&quot; /etc/init.d/elasticsearch;
perl -p -i -e &quot;s;\\%TEMPLATE_VAR_ELK_USER\\%;$USER;g&quot; /etc/init.d/elasticsearch;
perl -p -i -e &quot;s;\\%TEMPLATE_VAR_ELK_GROUP\\%;$GROUP;g&quot; /etc/init.d/elasticsearch;

if [ -e /etc/init.d/elasticsearch.bak ]; then
    rm -f /etc/init.d/elasticsearch.bak;
fi

# ====================== setup configs ======================
# $ELK_HOME_DIR/elasticsearch/config/jvm.options
# -Xms$USE_MEMORY, -Xmx$USE_MEMORY
perl -p -i -e &quot;s;\\bXms[0-9a-zA-Z]*\\b;Xms$USE_MEMORY;g&quot; $ELK_HOME_DIR/elasticsearch/config/jvm.options;
perl -p -i -e &quot;s;\\bXmx[0-9a-zA-Z]*\\b;Xmx$USE_MEMORY;g&quot; $ELK_HOME_DIR/elasticsearch/config/jvm.options;
sed -i &quot;/GC\\s*configuration/a -XX:MaxGCPauseMillis=1000&quot; $ELK_HOME_DIR/elasticsearch/config/jvm.options;
sed -i &quot;/GC\\s*configuration/a -XX:+UseG1GC&quot; $ELK_HOME_DIR/elasticsearch/config/jvm.options;
perl -p -i -e &quot;s;\\-XX:\\+UseConcMarkSweepGC;# -XX:+UseConcMarkSweepGC;g&quot; $ELK_HOME_DIR/elasticsearch/config/jvm.options;
perl -p -i -e &quot;s;\\-XX:CMSInitiatingOccupancyFraction;# -XX:CMSInitiatingOccupancyFraction;g&quot; $ELK_HOME_DIR/elasticsearch/config/jvm.options;
perl -p -i -e &quot;s;\\-XX:\\+UseCMSInitiatingOccupancyOnly;# -XX:+UseCMSInitiatingOccupancyOnly;g&quot; $ELK_HOME_DIR/elasticsearch/config/jvm.options;
perl -p -i -e &quot;s;\\-XX:HeapDumpPath=[^\\r\\n]*;-XX:HeapDumpPath=$ELK_DATA_DIR/dump/data;g&quot; $ELK_HOME_DIR/elasticsearch/config/jvm.options;
perl -p -i -e &quot;s;\\-XX:ErrorFile=[^\\r\\n]*;-XX:ErrorFile=$ELK_DATA_DIR/dump/logs/hs_err_pid%p.log;g&quot; $ELK_HOME_DIR/elasticsearch/config/jvm.options;

# $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml
# cluster.name: $ELK_CLUSTER_NAME
perl -p -i -e &quot;s;(\\#\\s*)?cluster\\s*.\\s*name:\\s*.*;cluster.name: \&quot;$ELK_CLUSTER_NAME\&quot;;g&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;

# node.name: &quot;app-node-$BIND_IP&quot;
perl -p -i -e &quot;s;(\\#\\s*)?node\\s*.\\s*name:\\s*.*;node.name: \&quot;app-node-$BIND_IP:$ELK_ELASTICSEARCH_PORT\&quot;;g&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;

# # @see https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html
# node.master: $(is_elk_master $BIND_IP)
# node.data: true
# node.ingest: true
# search.remote.connect: true
sed -i &quot;/node\\s*.\\s*master/d&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;
sed -i &quot;/node\\s*.\\s*data/d&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;
sed -i &quot;/node\\s*.\\s*ingest/d&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;
sed -i &quot;/search\\s*.\\s*remote\\s*.\\s*connect/d&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;
sed -i &quot;/node\\s*.\\s*name/a search.remote.connect: true&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;
sed -i &quot;/node\\s*.\\s*name/a node.ingest: true&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;
sed -i &quot;/node\\s*.\\s*name/a node.data: true&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;
sed -i &quot;/node\\s*.\\s*name/a node.master: $(is_elk_master $BIND_IP)&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;

# path.data: $ELK_DATA_DIR/elasticsearch/data
perl -p -i -e &quot;s;(\\#\\s*)?path\\s*.\\s*data:\\s*.*;path.data: $ELK_DATA_DIR/elasticsearch/data;g&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;

# path.logs: $ELK_DATA_DIR/elasticsearch/logs
perl -p -i -e &quot;s;(\\#\\s*)?path\\s*.\\s*logs:\\s*.*;path.logs: $ELK_DATA_DIR/elasticsearch/logs;g&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;

# network.host: $BIND_IP
perl -p -i -e &quot;s;(\\#\\s*)?network\\s*.\\s*host:\\s*.*;network.host: $BIND_IP;g&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;

# network.bind_host: [&quot;$BIND_IP&quot;]
sed -i &quot;/network\\s*.\\s*bind_host/d&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;
sed -i &quot;/network\\s*.\\s*host/a network.bind_host: [\&quot;$BIND_IP\&quot;]&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;

# http.port: $ELK_ELASTICSEARCH_PORT
perl -p -i -e &quot;s;(\\#\\s*)?http\\s*.\\s*port:\\s*.*;http.port: $ELK_ELASTICSEARCH_PORT;g&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;

# discovery.zen.ping.unicast.hosts: $(get_discovery_unicast)
perl -p -i -e &quot;s;(\\#\\s*)?discovery\\s*.\\s*zen\\s*.\\s*ping\\s*.\\s*unicast\\s*.\\s*hosts:\\s*.*;discovery.zen.ping.unicast.hosts: $(get_discovery_unicast);g&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;

# bootstrap.system_call_filter: false
sed -i &quot;/bootstrap\\s*.\\s*system_call_filter/d&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;
echo &quot;bootstrap.system_call_filter: false&quot; &gt;&gt; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;

# xpack.security.enabled: false 
# 使用非HTTPS接口必须关闭安全模块
sed -i &quot;/xpack\\s*.\\s*security\\s*.\\s*enabled/d&quot; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;
echo &quot;xpack.security.enabled: false&quot; &gt;&gt; $ELK_HOME_DIR/elasticsearch/config/elasticsearch.yml;

# ====================== setup x-pack ======================
chown $USER:$GROUP -R $ELK_DATA_DIR;
chown $USER:$GROUP -R $ELK_HOME_DIR;

# ************ 如果使用systemd的话这里换成systemd的启动脚本 ************
chmod +x /etc/init.d/elasticsearch;
/etc/init.d/elasticsearch start;

wait_for_elasticsearch_startup;
echo &quot;cd elasticsearch &amp;&amp; bin/elasticsearch-setup-passwords interactive&quot;;

# elastic, kibana, and logstash_system users
cd elasticsearch &amp;&amp; bin/elasticsearch-setup-passwords interactive;
cd -;

# 这里会需要手动输密码，请务必填成和 ELK_CLUSTER_PASSWORD 配置的一样，一遍后面检查API

# test users
curl -u elastic:$ELK_CLUSTER_PASSWORD &quot;http://$BIND_IP:$ELK_ELASTICSEARCH_PORT&quot;;
curl -u kibana:$ELK_CLUSTER_PASSWORD &quot;http://$BIND_IP:$ELK_ELASTICSEARCH_PORT&quot;;
curl -u logstash_system:$ELK_CLUSTER_PASSWORD &quot;http://$BIND_IP:$ELK_ELASTICSEARCH_PORT&quot;;
# curl -u elastic:$ELK_CLUSTER_PASSWORD &quot;http://$BIND_IP:$ELK_ELASTICSEARCH_PORT/_xpack/security/user/&lt;username&gt;/_password&quot; ;

# ====================== setup chkconfig ======================
# ************ 如果使用systemd的话这里换成systemd的启动脚本 ************
chkconfig --add elasticsearch ;
/etc/init.d/elasticsearch restart ;
wait_for_elasticsearch_startup;

# ====================== check license ======================
# curl -u elastic:$ELK_CLUSTER_PASSWORD &quot;http://$BIND_IP:$ELK_ELASTICSEARCH_PORT/_xpack/license&quot;;
</code></pre><p>以上，就可以比较方便地部署 <a href=https://www.elastic.co/cn/products/elasticsearch>elasticsearch</a>的多节点集群了。</p><h3 id=logstash-部署>logstash 部署</h3><p>然后需要对日志采集做部署，<a href=https://redis.io/>redis</a> 部署就补贴了，比较简单。单节点没写部署脚本，直接贴我的配置吧:</p><p>主配置: config/logstash.yml</p><pre><code class=language-yaml>node.name: logstash节点名称
path.data: 数据目录

http.host: &quot;监听IP&quot;
http.port: 9670-9700

log.level: info
path.logs: &quot;日志目录&quot;

# ------------ X-Pack Settings (not applicable for OSS build)--------------
#
# X-Pack Monitoring
# https://www.elastic.co/guide/en/logstash/current/monitoring-logstash.html
xpack.monitoring.enabled: true
xpack.monitoring.elasticsearch.url: [&quot;http://elasticsearch主节点1-IP:9200&quot;, &quot;http://elasticsearch主节点1-IP:9200&quot;]
xpack.monitoring.elasticsearch.username: logstash_system
xpack.monitoring.elasticsearch.password: &quot;密码&quot;
#xpack.monitoring.elasticsearch.ssl.ca: [ &quot;/path/to/ca.crt&quot; ]
#xpack.monitoring.elasticsearch.ssl.truststore.path: path/to/file
#xpack.monitoring.elasticsearch.ssl.truststore.password: password
#xpack.monitoring.elasticsearch.ssl.keystore.path: /path/to/file
#xpack.monitoring.elasticsearch.ssl.keystore.password: password
#xpack.monitoring.elasticsearch.ssl.verification_mode: certificate
xpack.monitoring.elasticsearch.sniffing: false
#xpack.monitoring.collection.interval: 10s
#xpack.monitoring.collection.pipeline.details.enabled: true
</code></pre><p>pipeline入口配置: config/pipelines.yml</p><pre><code class=language-yaml>- pipeline.id: app_to_redis
  pipeline.workers: 8
  queue.type: memory
  path.config: &quot;logstash主目录/config/app_to_redis.config&quot;

- pipeline.id: redis_to_elastic
  pipeline.workers: 8
  queue.type: memory
  path.config: &quot;logstash主目录/config/redis_to_elasticsearch.config&quot;
</code></pre><p>然后是pipeline - config/app_to_redis.config :</p><pre><code class=language-text>input {
    udp {
        port =&gt; 9345
        workers =&gt; 4
        codec =&gt; json {
            charset =&gt; 'UTF-8'
        }
    }
#   stdin {}  #可以从标准输入读数据
}

filter {
  #Only matched data are send to output.
  if ![log_type] { 
    drop { }
  }
  if ![log_name] {
    drop { }
  }
  if ![log_id] {
    drop { }
  }
  if [log_type] == &quot;osslog&quot; {
    if [log_name] not in [&quot;只选择部分需要的日志&quot;, &quot;&quot;] {
      if [log_name] !~ /^CSGMCmd-.*/ {
        drop { }
      }
    }
  }

  mutate {
    add_field =&gt; { &quot;lc_identifier&quot; =&gt; &quot;%{log_type}-%{log_name}-%{log_id}&quot; } # 这里是方便后面写规则定期清理和分类
  }
  mutate {
    lowercase =&gt; [ &quot;lc_identifier&quot; ]
  }
}
output {
  # For detail config for redis as output,
  # See: https://www.elastic.co/guide/en/logstash/6.4/plugins-outputs-redis.html
  redis {
    port =&gt; 16379
    key =&gt; &quot;logstash&quot;
    data_type =&gt; &quot;list&quot;
  }
}
</code></pre><p>最后是pipeline - config/app_to_redis.config :</p><pre><code class=language-text>input {
    redis {
        port =&gt; 16379
        data_type =&gt; &quot;list&quot;
        key =&gt; &quot;logstash&quot;
        codec =&gt; json {
            charset =&gt; 'UTF-8'
        }
    }
#   stdin {}  #可以从标准输入读数据
}
output {
  # For detail config for elasticsearch as output,
  # See: https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html
  elasticsearch {
    action =&gt; &quot;index&quot;                                                           # The operation on ES
    hosts  =&gt; [&quot;elasticsearch主节点1-IP:9200&quot;, &quot;elasticsearch主节点2-IP:9200&quot;]  # ElasticSearch host, can be array.
    index  =&gt; &quot;applog-%{lc_identifier}-%{+YYYY.MM.dd}&quot;                          # The index to write data to.
    user   =&gt; &quot;logstash_system&quot;
    password =&gt; &quot;密码&quot;
  }
}

</code></pre><p>最后加一下启动脚本就好了。</p><h3 id=kibana-部署>kibana 部署</h3><p><a href=https://www.elastic.co/cn/products/kibana>kibana</a> 是用于集群管理的，也贴一下我的配置吧。就一个文件 config/kibana.yml</p><pre><code class=language-yaml># 监听端口
server.port: 5601
server.host: &quot;监听地址&quot;

# 这个用于站点的子目录是kibana的时候，比如 http://127.0.0.1/elk/kibana
server.basePath: &quot;/elk/kibana&quot;

# The URL of the Elasticsearch instance to use for all your queries.
elasticsearch.url: &quot;http://elasticsearch主节点1-IP:9200&quot;

# When this setting's value is true Kibana uses the hostname specified in the server.host
# setting. When the value of this setting is false, Kibana uses the hostname of the host
# that connects to this Kibana instance.
#elasticsearch.preserveHost: true

# Kibana uses an index in Elasticsearch to store saved searches, visualizations and
# dashboards. Kibana creates a new index if the index doesn't already exist.
kibana.index: &quot;.kibana&quot;

elasticsearch.username: &quot;kibana&quot;
elasticsearch.password: &quot;密码&quot;

# pidfile 要和启动脚本列的一致
pid.file: pidfile路径/kibana.pid

i18n.defaultLocale: &quot;zh_CN&quot;
</code></pre><p>也是最后加一下启动脚本就好了。</p><p>我还用了nginx做反向代理，配置如下:</p><pre><code class=language-nginx>upstream elasticsearch {
    server elasticsearch主节点-IP:9200;
}

upstream kibana {
    server kibana监听地址:5601;
}

location ^~ /elk/elasticsearch {
    proxy_pass http://elasticsearch;
    rewrite ^/elk/elasticsearch(.*) $1 break;
    proxy_http_version 1.1;
    proxy_request_buffering off;
    proxy_buffering off;
    proxy_set_header  X-Real-IP  $remote_addr;
    add_header Access-Control-Allow-Origin *;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

location ^~ /elk/kibana {
    proxy_pass http://kibana;
    rewrite ^/elk/kibana(.*) $1 break;
    proxy_http_version 1.1;
    proxy_request_buffering off;
    proxy_buffering off;
    proxy_set_header  X-Real-IP  $remote_addr;
    add_header Access-Control-Allow-Origin *;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
</code></pre><h2 id=日志接入>日志接入</h2><p>日志接入我是用的是protobuf转json。然后用上面的UDP发送到 <a href=https://www.elastic.co/cn/products/logstash>logstash</a> 。这个也比较简单，就是额外多做了负载均衡支持和reload支持。不过多描述了。</p><h2 id=定期清理elasticsearch-curator>定期清理(elasticsearch-curator)</h2><p>我们使用的方式非常的暴力，没有做太多的索引优化，<a href=https://www.elastic.co/cn/products/elasticsearch>elasticsearch</a>的全文索引内存消耗爆炸高。所以用了个官方的工具 <a href=https://www.elastic.co/guide/en/elasticsearch/client/curator/current/index.html>elasticsearch-curator</a> 来定期清理掉不再需要的日志，具体使用可以见官方文档，我这里设置了清理30天以上的条目。</p><p>跪着文件: action</p><pre><code class=language-yaml>---
actions:
  1:
    action: delete_indices
    description: delete_indices
    options:
      timeout_override: 300
      continue_if_exception: True
      disable_action: False
    filters:
    - filtertype: age
      source: creation_date
      direction: older
      unit: days
      unit_count: 30
    - filtertype: pattern
      kind: prefix
      value: applog-  # 这个前缀要和上面的 pipeline 里的匹配
</code></pre><p>连接配置文件: curator.yml</p><pre><code class=language-yaml>---
client:
  hosts:
    - 主节点1-IP
    - 主节点2-IP
  port: 9200
  url_prefix:
  use_ssl: False
  certificate:
  client_cert:
  client_key:
  ssl_no_validate: False
  http_auth: ELK用户名:ELK用户密码
  timeout: 30
  master_only: False

logging:
  loglevel: INFO
  logfile:
  logformat: default
  blacklist: ['elasticsearch', 'urllib3']
</code></pre><p>这个工具需要python3，然后定时执行就行了。</p><pre><code class=language-bash>#!/bin/bash

export LC_ALL=en_US.utf8

cd &quot;$(dirname $0)&quot;;

curator --config curator.yml actions
</code></pre><h2 id=最后sample>最后Sample</h2><p>最后贴一张我们项目内用的图吧。</p><p><img src=1812-02.png alt=1812-02.png></p><p>上面的图是我拿来分析项目的错误码分布和监控远程调用和任务的健康情况的（失败率、延迟之类），其实更深入的使用不止于此，比如拿来查测试账号的登入时间点和登入服务器，对开发调试非常有用。我们的验证数据上报和抓取也是靠它，甚至可以加事件脚本来做告警等等。</p></div><hr><footer class=article-footer><div class="article-panel-footer article-meta article-footer clearfix"><span class=article-meta-left><ol><li><a href=//owent.net/categories/article.html>Article</a></li><li><a href=//owent.net/categories/blablabla.html>Blablabla</a></li></ol></span><span class=article-meta-right><time datetime=2018-11-17T02:00:00.000+00:00 itemprop=datePublished>2018-11-17</time></span>
<span class=clearfix></span></div><div class=article-tags><ul class=article-tag-list><li class=article-tag-list-item><a href=//owent.net/tags/elk.html>ELK</a></li><li class=article-tag-list-item><a href=//owent.net/tags/elasticsearch.html>elasticsearch</a></li><li class=article-tag-list-item><a href=//owent.net/tags/logstash.html>logstash</a></li><li class=article-tag-list-item><a href=//owent.net/tags/kibana.html>kibana</a></li><li class=article-tag-list-item><a href=//owent.net/tags/kafka.html>kafka</a></li><li class=article-tag-list-item><a href=//owent.net/tags/redis.html>redis</a></li><li class=article-tag-list-item><a href=//owent.net/tags/pulsar.html>pulsar</a></li></ul></div></footer><div class="ads-placeholder ads-container"><ins class="adsbygoogle ads_infeed" style=display:block data-ad-client=ca-pub-8180054975285991 data-ad-slot=5599802929 data-ad-format="rectangle, horizontal" data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><hr><nav id=article-nav><ul class=pagination><li class=page-item><a class=page-link id=article-nav-newer class=article-nav-link-wrap href=//owent.net/2019/1901.html>上一篇<strong>Rust玩具-企业微信机器人通用服务</strong></a></li><li class=page-item><a class=page-link id=article-nav-older class=article-nav-link-wrap href=//owent.net/2018/1810.html>下一篇<strong>2018年的新通用伪随机数算法(xoshiro / xoroshiro)的C++(head only)实现</strong></a></li></ul></nav><hr><script src=https://utteranc.es/client.js repo=owent/blog-website issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></article></div></section></div><footer id=footer><div class=outer><div id=footer-info class="inner clearfix"><strong id=footer-left class="float-left float-start"><a rel=license href=https://github.com/owent/blog-hugo/blob/master/LICENSE.md><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png></a>2025&nbsp;owent
</strong><strong id=footer-right class="float-right float-end"><a href=https://beian.miit.gov.cn/ target=_blank>沪ICP备2022003252号</a>&nbsp;&nbsp;<a href=https://github.com/owent/blog-hugo target=_blank>本站源码</a>,
发布者 <a href=https://gohugo.io/ target=_blank>Hugo</a>,
主题 <a href=https://github.com/owent/hugo-theme-distinctionpp target=_blank>distinctionpp</a>
</strong><span class=clearfix></span></div></div></footer></div><script type=importmap>
{"imports":{"@popperjs/core":"https://esm.run/popper.js","bootstrap":"https://esm.run/bootstrap","react":"https://esm.run/react","react-bootstrap":"https://esm.run/react-bootstrap"}}
</script><script type=module>// import * as Popper from "@popperjs/core";// import * as bootstrap from "bootstrap";
// import React from "react";

        
</script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/accesslog.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/armasm.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/awk.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/basic.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/bnf.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/capnproto.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/cmake.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/d.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/dockerfile.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/dos.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/erlang.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/ebnf.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/latex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/llvm.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/lua.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/powershell.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/protobuf.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/profile.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/vim.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/x86asm.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/yaml.min.js></script><script type=text/javascript>document.addEventListener("DOMContentLoaded",e=>{const t=document.createElement("link");t.rel="stylesheet",t.href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/vs2015.min.css",document.querySelector("head").appendChild(t),window.JSON?hljs.configure(JSON.parse('{"ignoreunescapedhtml":true,"languages":{},"tabreplace":"    ","throwunescapedhtml":false,"usebr":false}')):hljs.configure(evel('{"ignoreunescapedhtml":true,"languages":{},"tabreplace":"    ","throwunescapedhtml":false,"usebr":false}'));const n={};for(const e of hljs.listLanguages())n[e.toLowerCase()]=!0;for(const e of document.querySelectorAll("pre>code"))try{if(e.className.match(/\bmermaid\b/i)){e.classList.add("mermaid");continue}if(e.className.match(/\bexcalidraw\b/i)){e.classList.add("excalidraw-root");continue}if(e.className.match(/\bnohighlight\b/i))continue;const t=e.className.match(/language-([^\s]+)/i);if(t&&t.length>=2&&hljs.getLanguage(t[1]))hljs.highlightElement(e);else{const t=hljs.highlightAuto(e.innerText,hljs.listLanguages());t&&t.value&&(e.innerHTML=t.value,e.classList.add("hljs"))}}catch(e){window.console&&console.log(e.toString()+`\r
Maybe can not detect the language`)}})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PQEY77BYG1"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PQEY77BYG1")}</script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js></script><script type=text/javascript>document.addEventListener("DOMContentLoaded",e=>{const t=document.createElement("link");t.rel="stylesheet",t.href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css",document.querySelector("head").appendChild(t),renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"$",right:"$",display:!1}],throwOnError:!1,ignoredTags:["script","noscript","style","textarea","pre","code"]})})</script><script type=text/javascript>var _hmt=_hmt||[];(function(){var t,n,e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6a0daf8d58889f1cf55a353867bfdbb0",t=document.getElementsByTagName("script"),n=document.getElementsByTagName("script")[t.length-1],n.parentNode.appendChild(e)})()</script></div></body></html>