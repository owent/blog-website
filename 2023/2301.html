<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>给cmake-toolset和工具链(curl等)加HTTP/2和HTTP/3支持|I'm OWenT</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=canonical href=//owent.net/2023/2301.html><link rel=icon href=../favicon.ico><link rel=stylesheet href=//unpkg.com/bootstrap@latest/dist/css/bootstrap.min.css crossorigin=anonymous><link rel=stylesheet href=//owent.net//css/style.css><link rel=stylesheet href=//owent.net/css/syntax.css><script type=importmap>
{
  "imports": {
    "react": "//unpkg.com/react@latest",
    "react-bootstrap": "//unpkg.com/react-bootstrap@latest",
    "mermaid": "//unpkg.com/mermaid@latest/dist/mermaid.esm.min.mjs",
    "bootstrap": "//unpkg.com/bootstrap@latest/dist/js/bootstrap.esm.min.js",
    "@popperjs/core": "//unpkg.com/@popperjs/core@latest/dist/esm/popper.js"
  }
}
</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8180054975285991" crossorigin=anonymous></script><meta name=baidu-site-verification content="codeva-4M5iohb9TW"></head><body><div id=container><div id=wrap><header id=header><div id=banner></div><div id=header-outer><div id=header-title><h1 id=site-title><a href=//owent.net/ id=logo>I'm OWenT</a></h1><h2 id=site-description>Challenge Everything</h2></div><div id=header-inner><nav id=main-nav class="navbar navbar-expand-md navbar-dark"><button class="navbar-toggler navbar-toggler-right" type=button data-bs-toggle=collapse data-bs-target=#main-nav-links aria-controls=main-nav-links aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<a id=main-nav-brand class="navbar-brand collapse" href=#>#</a><div class="collapse navbar-collapse position-relative" id=main-nav-links><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=../ title=Home>Home</a></li><li class=nav-item><a class=nav-link href=../archives.html title=Archives>Archives</a></li><li class=nav-item><a class=nav-link href=../about.html title=About>About</a></li><li class="nav-item nav-ads ads-placeholder ads-container"><ins class="adsbygoogle ads_menu" style=display:block data-ad-client=ca-pub-8180054975285991 data-ad-slot=4450372783 data-ad-format=auto data-full-width-responsive=true></ins></li></ul><div class="col-12 col-xl-2 col-lg-3 col-md-4" id=main-nav-search><form class=input-group method=get accept-charset=UTF-8 action=//www.bing.com/search><input type=hidden name=q1 value=site:owent.net>
<input class=form-control type=text placeholder=搜索 name=q>
<button class="btn btn-outline-secondary my-0" type=submit>搜索</button></form></div></div></nav></div></div></header><div id=main><section id=main-content><div id=post-content><article id=post-d0ead8aac26586f48da7bed24ad42a6b class="article-panel article article-type-post" itemscope itemprop=blogPost><div class="article-panel-inner article-inner"><div class=article-inner><header class=article-header><h1 itemprop=name><a class=article-title href=//owent.net/2023/2301.html target=_blank itemprop=url>给cmake-toolset和工具链(curl等)加HTTP/2和HTTP/3支持</a></h1></header><hr><div id=toc class="well toc m-3 p-1 pr-1 pt-1 pb-2 float-md-right float-md-end"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#构建工具-cmake-toolset1-和-curl2>构建工具 <a href=https://github.com/atframework/cmake-toolset>cmake-toolset</a> 和 <a href=https://github.com/curl/curl.git>curl</a></a></li><li><a href=#nghttp23nghttp34ngtcp25构建流程的一些问题><a href=https://github.com/nghttp2/nghttp2.git>nghttp2</a>,<a href=https://github.com/ngtcp2/nghttp3.git>nghttp3</a>,<a href=https://github.com/ngtcp2/ngtcp2.git>ngtcp2</a>构建流程的一些问题</a></li><li><a href=#curl2-的future检测问题><a href=https://github.com/curl/curl.git>curl</a> 的Future检测问题</a></li><li><a href=#最后>最后</a></li></ul></nav><div class="ads-placeholder ads-container"><ins class="adsbygoogle ads_toc" style=display:block data-ad-client=ca-pub-8180054975285991 data-ad-slot=1249494377 data-ad-format=auto data-full-width-responsive=true></ins></div></div><br><div class=article-entry itemprop=articleBody><h2 id=前言>前言</h2><p>前段时间集成一些公司内组件的时候发现它依赖 <a href=https://github.com/nghttp2/nghttp2.git>nghttp2</a> 。正好之前一直有给我的构建工具(<a href=https://github.com/atframework/cmake-toolset>cmake-toolset</a>)里的构建 <a href=https://github.com/curl/curl.git>curl</a> 的流程加 HTTP/2 和 HTTP/3 的计划。
所以这波一次性搞定了。</p><h2 id=构建工具-cmake-toolset1-和-curl2>构建工具 <a href=https://github.com/atframework/cmake-toolset>cmake-toolset</a> 和 <a href=https://github.com/curl/curl.git>curl</a></h2><p>首先，<a href=https://github.com/curl/curl.git>curl</a> 是支持多种第三方库作为 HTTP/2 和 HTTP/3（QUIC）算法库的。比如 <a href=https://github.com/ngtcp2/nghttp3.git>nghttp3</a>+<a href=https://github.com/ngtcp2/ngtcp2.git>ngtcp2</a>，或者微软家 <a href=https://github.com/microsoft/msquic>msquic</a>，或者Google家 <a href=https://github.com/google/quiche>quiche</a>。
其中HTTP/3只能选一个，互相是冲突的。而Google的<a href=https://github.com/google/quiche>quiche</a>官方仅有对bazel构建系统的支持，而我的<a href=https://github.com/atframework/cmake-toolset>cmake-toolset</a>是cmake生态的。
这里选用 <a href=https://github.com/ngtcp2/nghttp3.git>nghttp3</a>+<a href=https://github.com/ngtcp2/ngtcp2.git>ngtcp2</a> 的组合，主要是为了和其他的模块共享依赖。</p><p>另外无论选哪一个HTTP/2 和 HTTP/3（QUIC）算法库，都需要SSL层支持quic算法。那目前官方版本的 <a href=https://www.openssl.org/>openssl</a> 是不支持的。我们可以选用 <a href=https://github.com/quictls/openssl>quictls版本的openssl</a> 或者 <a href=https://github.com/google/boringssl>boringssl</a>。
其中 <a href=https://github.com/quictls/openssl>quictls版本的openssl</a> 对一些非Google系的开源库支持性更好一些。在 <a href=https://github.com/atframework/cmake-toolset>cmake-toolset</a> 中两种都支持，但是我们首选 <a href=https://github.com/quictls/openssl>quictls版本的openssl</a>。</p><p><a href=https://github.com/nghttp2/nghttp2.git>nghttp2</a>,<a href=https://github.com/ngtcp2/nghttp3.git>nghttp3</a>和<a href=https://github.com/ngtcp2/ngtcp2.git>ngtcp2</a>的依赖关系是 <a href=https://github.com/ngtcp2/ngtcp2.git>ngtcp2</a>依赖<a href=https://github.com/ngtcp2/nghttp3.git>nghttp3</a>，<a href=https://github.com/nghttp2/nghttp2.git>nghttp2</a>依赖<a href=https://github.com/ngtcp2/ngtcp2.git>ngtcp2</a>。由于 <a href=https://github.com/atframework/cmake-toolset>cmake-toolset</a> 中增加第三方库的流程已经比较成熟了，所以加这些组件的编译流程并不是什么难事。但是最后集成这个几个库组合起来的时候，还是碰到了一些问题。</p><h2 id=nghttp23nghttp34ngtcp25构建流程的一些问题><a href=https://github.com/nghttp2/nghttp2.git>nghttp2</a>,<a href=https://github.com/ngtcp2/nghttp3.git>nghttp3</a>,<a href=https://github.com/ngtcp2/ngtcp2.git>ngtcp2</a>构建流程的一些问题</h2><p><a href=https://github.com/nghttp2/nghttp2.git>nghttp2</a>,<a href=https://github.com/ngtcp2/nghttp3.git>nghttp3</a>和<a href=https://github.com/ngtcp2/ngtcp2.git>ngtcp2</a>的工程结构很相似，所以问题点也很相似。</p><p>首先是我们需要让他们使用我们自己的 <a href=https://www.openssl.org/>openssl</a> 库。它们的构建脚本都可以让我们自己指定 <a href=https://www.openssl.org/>openssl</a> 的位置。在使用 <a href=https://github.com/google/boringssl>boringssl</a> 的时候，因为使用了非标准的老式引入方式（非cmake CONFIG模式），我们指定 <code>-DBORINGSSL_LIBRARIES=&lt;libraries></code> 的时候包含多个库文件。
我们的构建系统辅助接口传入到 cmake 的 <a href=https://cmake.org/cmake/help/latest/command/cmake_parse_arguments.html>cmake_parse_arguments</a> 接口的时候始终会被拆成多个参数。比如我们设置 <code>-DBORINGSSL_LIBRARIES=a;b</code> ，传入到 <a href=https://cmake.org/cmake/help/latest/command/cmake_parse_arguments.html>cmake_parse_arguments</a> 接口的时候一定会被拆分成 <code>-DBORINGSSL_LIBRARIES=a</code> 和 <code>b</code> ，无论我用是否加转义。这里借鉴了官方 Moudle <a href=https://cmake.org/cmake/help/latest/module/ExternalProject.html>ExternalProject</a> 的方式，加了一个类似 <code>LIST_SEPARATOR</code> 的选项，在接口里层做转换。</p><p>其次 <a href=https://github.com/nghttp2/nghttp2.git>nghttp2</a>,<a href=https://github.com/ngtcp2/nghttp3.git>nghttp3</a>和<a href=https://github.com/ngtcp2/ngtcp2.git>ngtcp2</a> 的构建流程中，都是通过一个宏来控制他们是否是输出的静态库（ <code>NGHTTP2_STATICLIB</code> ， <code>NGHTTP3_STATICLIB</code>和 <code>NGTCP2_STATICLIB</code> ）。
这些宏和符号导出标记和可见性相关，我们是需要编译时和链接时保持一致的，否则可能会链接的时候符号找不到。
如果按照cmake CONFIG的标准模式来，这些宏应该在install的时候导出到CONFIG文件里，这样下游模块链接的时候就能自动加上这个宏。
但是这几个库的cmake构建脚本都没有根据当前构建的库的类型来处理宏的导出，所以这里我们也需要适配处理一下。而且这里要注意既要在编译时按需加上这些宏，也需要Patch install后的imported target来设置PUBLIC definition 。</p><p>另外 <a href=https://github.com/nghttp2/nghttp2.git>nghttp2</a>的构建碰到了一个兼容性问题，它在输出的头文件里直接使用了 <code>ssize_t</code> 这个类型，但是有些平台中，这个类型是不存在的，所以也需要处理适配添加一下。</p><p>最后的构建脚本如下:</p><ul><li><a href=https://github.com/atframework/cmake-toolset/blob/main/ports/nghttp2/nghttp2.cmake>https://github.com/atframework/cmake-toolset/blob/main/ports/nghttp2/nghttp2.cmake</a></li><li><a href=https://github.com/atframework/cmake-toolset/blob/main/ports/ngtcp2/nghttp3.cmake>https://github.com/atframework/cmake-toolset/blob/main/ports/ngtcp2/nghttp3.cmake</a></li><li><a href=https://github.com/atframework/cmake-toolset/blob/main/ports/ngtcp2/ngtcp2.cmake>https://github.com/atframework/cmake-toolset/blob/main/ports/ngtcp2/ngtcp2.cmake</a></li></ul><h2 id=curl2-的future检测问题><a href=https://github.com/curl/curl.git>curl</a> 的Future检测问题</h2><p>最后在接入到 <a href=https://github.com/curl/curl.git>curl</a> 的时候也碰到了几个问题，基本上都是导致 <a href=https://github.com/curl/curl.git>curl</a> 检测 <a href=https://github.com/nghttp2/nghttp2.git>nghttp2</a>,<a href=https://github.com/ngtcp2/nghttp3.git>nghttp3</a>和<a href=https://github.com/ngtcp2/ngtcp2.git>ngtcp2</a> 失败而最终导致没开开启 HTTP/2 和 HTTP/3（QUIC） 。</p><p>一方面针对于上面提到的 <a href=https://github.com/nghttp2/nghttp2.git>nghttp2</a>,<a href=https://github.com/ngtcp2/nghttp3.git>nghttp3</a>,<a href=https://github.com/ngtcp2/ngtcp2.git>ngtcp2</a> 的静态库宏问题和 <code>ssize_t</code> 类型的问题，我也推了个PR到 <a href=https://github.com/curl/curl.git>curl</a> （ <a href=https://github.com/curl/curl/pull/10364>https://github.com/curl/curl/pull/10364</a> ）去适配，还需要等维护者进一步Review之后可能才会合入。目前我在 <a href=https://github.com/atframework/cmake-toolset>cmake-toolset</a> 里写了 Patch 文件（ <a href=https://github.com/atframework/cmake-toolset/blob/main/ports/libcurl/libcurl-7.87.patch>https://github.com/atframework/cmake-toolset/blob/main/ports/libcurl/libcurl-7.87.patch</a> ）来适配。</p><p>另外还碰到在Windows平台上，<a href=https://github.com/curl/curl.git>curl</a> 缺失链接了几个 <a href=https://www.openssl.org/>openssl</a> 依赖的系统库，导致检测依赖库的时候链接失败而检测失败，这些库也是补上就好了。整体来说 <a href=https://github.com/curl/curl.git>curl</a> 的整个工程质量还是很高的。</p><h2 id=最后>最后</h2><p>至此，整个适配接入就完成了，可能哪天有空了也我可以试着接入一下 <a href=https://github.com/microsoft/msquic>msquic</a> ，这样可选项就更多了。</p><p>也欢迎有兴趣的小伙伴互相交流研究。</p></div><hr><footer class=article-footer><div class="article-panel-footer article-meta article-footer clearfix"><span class=article-meta-left><ol><li><a href=//owent.net/categories/article.html>Article</a></li><li><a href=//owent.net/categories/blablabla.html>Blablabla</a></li></ol></span><span class=article-meta-right><time datetime=2023-01-30T11:39:45.000+00:00 itemprop=datePublished>2023-01-30</time></span>
<span class=clearfix></span></div><div class=article-tags><ul class=article-tag-list><li class=article-tag-list-item><a href=//owent.net/tags/cmake.html>cmake</a></li><li class=article-tag-list-item><a href=//owent.net/tags/toolset.html>toolset</a></li><li class=article-tag-list-item><a href=//owent.net/tags/curl.html>curl</a></li><li class=article-tag-list-item><a href=//owent.net/tags/http2.html>http2</a></li><li class=article-tag-list-item><a href=//owent.net/tags/http3.html>http3</a></li><li class=article-tag-list-item><a href=//owent.net/tags/quic.html>quic</a></li><li class=article-tag-list-item><a href=//owent.net/tags/nghttp2.html>nghttp2</a></li><li class=article-tag-list-item><a href=//owent.net/tags/nghttp3.html>nghttp3</a></li><li class=article-tag-list-item><a href=//owent.net/tags/ngtcp2.html>ngtcp2</a></li></ul></div></footer><div class="ads-placeholder ads-container"><ins class="adsbygoogle ads_infeed" style=display:block data-ad-client=ca-pub-8180054975285991 data-ad-slot=5599802929 data-ad-format=auto data-full-width-responsive=true></ins></div></div><hr><nav id=article-nav><ul class=pagination><li class=page-item><a class=page-link id=article-nav-newer class=article-nav-link-wrap href=//owent.net/2023/2302.html>上一篇<strong>Opentelemetry-cpp的Logs模块标准更新(涉及近期版本:1.8-1.9的BREAK CHANGES)</strong></a></li><li class=page-item><a class=page-link id=article-nav-older class=article-nav-link-wrap href=//owent.net/2022/2210.html>下一篇<strong>又开新坑之 coredns 插件: nftables和filter</strong></a></li></ul></nav><hr><script src=https://utteranc.es/client.js repo=owent/blog-website issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></article></div></section></div><footer id=footer><div class=outer><div id=footer-info class="inner clearfix"><strong id=footer-left class="float-left float-start"><a rel=license href=https://github.com/owent/blog-hugo/blob/master/LICENSE.md><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png></a>
2024
owent
</strong><strong id=footer-right class="float-right float-end"><a href=https://github.com/owent/blog-hugo target=_blank>本站源码</a>,
发布者 <a href=https://gohugo.io/ target=_blank>Hugo</a>,
主题 <a href=https://github.com/owent/hugo-theme-distinctionpp target=_blank>distinctionpp</a>
</strong><span class=clearfix></span></div></div></footer></div><script type=module>
import * as Popper from "@popperjs/core";
import * as bootstrap from 'bootstrap';
// import React from "react";

</script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/highlight.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/awk.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/bash.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/cpp.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/capnproto.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/cmake.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/d.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/diff.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/dockerfile.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/dos.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/erlang.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/go.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/less.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/llvm.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/lua.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/php.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/powershell.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/protobuf.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/python.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/profile.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/typescript.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/vim.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/rust.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/yaml.min.js></script><script type=text/javascript>document.addEventListener("DOMContentLoaded",e=>{const t=document.createElement("link");t.rel="stylesheet",t.href="//unpkg.com/@highlightjs/cdn-assets@latest/styles/vs2015.min.css",document.querySelector("head").appendChild(t),window.JSON?hljs.configure(JSON.parse('{"ignoreunescapedhtml":true,"languages":{},"tabreplace":"    ","throwunescapedhtml":false,"usebr":false}')):hljs.configure(evel('{"ignoreunescapedhtml":true,"languages":{},"tabreplace":"    ","throwunescapedhtml":false,"usebr":false}'));const n={};for(const e of hljs.listLanguages())n[e.toLowerCase()]=!0;for(const e of document.querySelectorAll("pre>code"))try{if(e.className.match(/\bmermaid\b/i)){e.classList.add("mermaid");continue}if(e.className.match(/\bnohighlight\b/i))continue;const t=e.className.match(/language-([^\s]+)/i);if(t&&t.length>=2&&hljs.getLanguage(t[1]))hljs.highlightElement(e);else{const t=hljs.highlightAuto(e.innerText,hljs.listLanguages());t&&t.value&&(e.innerHTML=t.value,e.classList.add("hljs"))}}catch(e){window.console&&console.log(e.toString()+`\r
Maybe can not detect the language`)}})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PQEY77BYG1"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PQEY77BYG1")}</script><script type=text/javascript src=//unpkg.com/katex@latest/dist/katex.min.js></script><script type=text/javascript src=//unpkg.com/katex@latest/dist/contrib/auto-render.min.js></script><script type=text/javascript>document.addEventListener("DOMContentLoaded",e=>{const t=document.createElement("link");t.rel="stylesheet",t.href="//unpkg.com/katex@latest/dist/katex.min.css",document.querySelector("head").appendChild(t),renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"$",right:"$",display:!1}],throwOnError:!1,ignoredTags:["script","noscript","style","textarea","pre","code"]})})</script><script type=text/javascript src=//unpkg.com/chart.js@latest/dist/chart.umd.js></script><script type=module>
import mermaid from "mermaid";
const config = {
    theme: 'neutral',
    logLevel: 'fatal',
    securityLevel: 'loose', 
    startOnLoad: true,
    arrowMarkerAbsolute: false,
    

};
mermaid.initialize(config);
</script><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></body></html>