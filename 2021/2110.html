<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>适配Boringssl和OpenSSL 3.0|I'm OWenT</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=canonical href=//owent.net/2021/2110.html><link rel=icon href=../favicon.ico><link rel=stylesheet href=//unpkg.com/bootstrap@latest/dist/css/bootstrap.min.css crossorigin=anonymous><link rel=stylesheet href=//owent.net//css/style.css><script type=text/javascript src=//unpkg.com/jquery@latest/dist/jquery.slim.min.js crossorigin=anonymous></script><link rel=stylesheet href=//owent.net/css/syntax.css><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8180054975285991" crossorigin=anonymous></script><meta name=baidu-site-verification content="Vsc27DkHq2"><meta name=baidu-site-verification content="Nr2nabjqKj"></head><body><div id=container><div id=wrap><header id=header><div id=banner></div><div id=header-outer><div id=header-title><h1 id=site-title><a href=//owent.net/ id=logo>I'm OWenT</a></h1><h2 id=site-description>Challenge Everything</h2></div><div id=header-inner><nav id=main-nav class="navbar navbar-expand-md navbar-dark"><button class="navbar-toggler navbar-toggler-right" type=button data-toggle=collapse data-target=#main-nav-links aria-controls=main-nav-links aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<a id=main-nav-brand class="navbar-brand collapse" href=#>#</a><div class="collapse navbar-collapse position-relative" id=main-nav-links><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=../ title=Home>Home</a></li><li class=nav-item><a class=nav-link href=../archives.html title=Archives>Archives</a></li><li class=nav-item><a class=nav-link href=../about.html title=About>About</a></li></ul><div class="col-2 position-absolute end-0"><form class=input-group method=get accept-charset=UTF-8 action=//www.bing.com/search><input type=hidden name=q1 value=site:owent.net>
<input class=form-control type=text placeholder=搜索 name=q>
<button class="btn btn-outline-secondary my-2 my-sm-0" type=submit>搜索</button></form></div></div></nav></div></div></header><div id=main><section id=main-content><div id=post-content><article id=post-f39dff3d0e2226a8d9fad8603d373a7d class="article-panel article article-type-post" itemscope itemprop=blogPost><div class="article-panel-inner article-inner"><div class=article-inner><header class=article-header><h1 itemprop=name><a class=article-title href=//owent.net/2021/2110.html target=_blank itemprop=url>适配Boringssl和OpenSSL 3.0</a></h1></header><hr><div id=toc class="well toc m-3 p-1 pr-1 pt-1 pb-2 float-md-right float-md-end"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#boringssl>Boringssl</a></li><li><a href=#openssl-30>OpenSSL 3.0</a></li><li><a href=#写在最后>写在最后</a></li></ul></nav></div><br><div class=article-entry itemprop=articleBody><h2 id=前言>前言</h2><p><a href=https://www.openssl.org/>openssl</a> 3.0发布好一阵子了，我的 <a href=https://github.com/atframework/atframe_utils>atframe_utils</a> 其实也挺早前就完成了对 <a href=https://www.openssl.org/>openssl</a> 3.0 和 <a href=https://github.com/google/boringssl>boringssl</a> 的适配。但是由于懒，一直没写这篇文章。在升级 [openssl] 3.0 和 <a href=https://github.com/google/boringssl>boringssl</a> 还是碰到了一些问题的，有些是由于接口变化，有些是由于功能支持还有些也和构建系统相关。还是有必要记录一下，至少能方便以后查找。</p><h2 id=boringssl>Boringssl</h2><p><a href=https://github.com/google/boringssl>boringssl</a> 是Goolge对早期 <a href=https://www.openssl.org/>openssl</a> 的fork和魔改。大部分接口是相同的，而且它原生支持了 <a href=https://cmake.org/>cmake</a> 构建系统，所以接入起来相对容易（特别是涉及交叉编译的时候）。但是这个 <a href=https://cmake.org/>cmake</a> 的支持还是有一些问题。</p><p>首先， <a href=https://github.com/google/boringssl>boringssl</a> 的代码兼容性感觉并没有 <a href=https://www.openssl.org/>openssl</a> 好，但是它非得开 <code>/WX</code> (MSVC) 和 <code>-Werror</code> (GCC/Clang)。于是有些编译环境，特别是高版本的编译器会有warning导致编译不过。其次它的子模块 <code>boringssl_gtest</code> 在Windows上编译成动态库是有问题的。最后更重要的问题， <a href=https://github.com/google/boringssl>boringssl</a> 的 <a href=https://cmake.org/>cmake</a> 脚本并没有正确设置 <strong>install</strong> 目标。所以首先构建系统上需要解决这些问题。</p><blockquote><p><a href=https://github.com/google/boringssl>boringssl</a> 我适配的这个版本的编译不过包含 utf-8 char 不能隐式转换到 <code>const char*</code> ， 有代码申明为 <code>int x509v3_a2i_ipadd(unsigned char ipout[16], const char *ipasc)</code> 但是实现是 <code>int x509v3_a2i_ipadd(unsigned char* ipout, const char *ipasc)</code> 等等。</p></blockquote><p>然后在代码适配层面，<a href=https://github.com/google/boringssl>boringssl</a> 比较激进似乎删掉了很多不是那么古老的算法，其中就包含 DH 密钥交换。于是我在使用 <a href=https://github.com/google/boringssl>boringssl</a> 接入 <a href=https://github.com/atframework/atframe_utils>atframe_utils</a> 的 <code>crypto_dh</code> 是不得不移除DH算法，仅保留 ECDH 。</p><h2 id=openssl-30>OpenSSL 3.0</h2><p><a href=https://www.openssl.org/>openssl</a> 3.0 优化了很多流程，它输出的库目录更加标准化了，这也带来了一些 <a href=https://cmake.org/>cmake</a> 适配上的问题。首先，有些平台下 <a href=https://www.openssl.org/>openssl</a> 3.0 会把安装的库放在 <strong>lib64</strong> 目录下。但是 <a href=https://cmake.org/>cmake</a> 官方的 <code>FindOpenSSL.cmake</code> 脚本中（3.0-3.21版本都是如此），写死了只查找 <code>lib</code> 目录。我现在的解决方法是在编译 <a href=https://www.openssl.org/>openssl</a> 3.0 的时候强行指定 <code>"--libdir=${PROJECT_THIRD_PARTY_INSTALL_DIR}/lib"</code> ，这样可以兼容一些其他直接使用 <a href=https://cmake.org/>cmake</a> 的 <code>FindOpenSSL.cmake</code> 的第三方组件。</p><p>第二个问题之前的版本应该就有，只是没测试到位。在 <a href=https://cmake.org/>cmake</a> 不使用 <code>* Makefile</code> 而使用 <a href=https://ninja-build.org/>Ninja</a> 作为构建系统Generator时，<code>CMAKE_MAKE_PROGRAM</code> 这个变量指向的是 <code>ninja</code> 。而像 <a href=https://www.openssl.org/>openssl</a> 这类在 Unix Like 系统下只能用 Makefile 的 packages 来说，就不能透传 <code>CMAKE_MAKE_PROGRAM</code> 作为构建工具，必须自己查找。自己查找的话还有另一个问题是在 <strong>MinGW</strong> 环境下，是有可能没有安装 <code>make</code> 仅安装了 <code>mingw32-make</code> 的。这些都是构建系统上需要适配的内容。</p><p>在接口和功能上， <a href=https://www.openssl.org/>openssl</a> 正在逐步淘汰古老的低级API，转而使用高级版本的接口 <code>EVP_PKEY_*</code> 等。在 <a href=https://www.openssl.org/>openssl</a> 3.0 中，则是移除了 DH 算法的低级API，于是我们这里又要进行适配。详情可以见 <a href=https://github.com/openssl/openssl/blob/master/doc/man7/migration_guide.pod>migration_guide</a> 中的 <a href=https://github.com/openssl/openssl/blob/master/doc/man7/migration_guide.pod#main-changes-from-openssl-111>Main Changes from OpenSSL 1.1.1</a> 。简单地说，新版本的 <a href=https://www.openssl.org/>openssl</a> 提供了一组高级接口的 <a href=https://www.openssl.org/docs/manmaster/man3/OSSL_LIB_CTX.html>OSSL</a> 库，对多种不同的算法进行了流程上的统一封装。我们就可以使用这一组新的高级接口来操作 DH 密钥交换算法。</p><p>在重新适配接入 <a href=https://www.openssl.org/>openssl</a> 的 DH 密钥交换算法过程中，我还发现了一个坑，那就是 <code>EVP_PKEY_set_bn_param()</code> 无效，返回正确但是实际上并没有起任何作用，并不像 ECDH 可以直接用高级接口，我没有深究所以不清楚是 BUG 还是设计如此。在这方面， <a href=https://www.openssl.org/>openssl</a> 的文档还是有一些滞后和粗略，我们目前解决这个问题的方案仍然是通过看 <a href=https://www.openssl.org/>openssl</a> 3.0 的 <code>OSSL_*</code> 的相关的代码流程来自己完成类似的功能。这套接口的流程和代码位置和之前版本的 <a href=https://www.openssl.org/>openssl</a> 差异也比较大，找起来还挺费劲的。主要是把 <code>EVP_PKEY_set_bn_param()</code> 换成了 <code>OSSL_PARAM_BLD_push_BN()</code> 。</p><h2 id=写在最后>写在最后</h2><p>大体上适配 <a href=https://www.openssl.org/>openssl</a> 3.0 和 <a href=https://github.com/google/boringssl>boringssl</a> 就这些问题。其中 <a href=https://github.com/google/boringssl>boringssl</a> 需要打patch，而且和版本相关性比较大，我写进了构建系统中，并且增加了 iOS、Android、iPhoneSimulator的交叉编译检测。可能后面 <a href=https://github.com/google/boringssl>boringssl</a> 我更新不会那么频繁，有些warning也许后面也会被修复一些。</p><p>最后也欢迎有兴趣的小伙伴们互相交流。</p></div><hr><footer class=article-footer><div class="article-panel-footer article-meta article-footer clearfix"><span class=article-meta-left><ol><li><a href=//owent.net/categories/article.html>Article</a></li><li><a href=//owent.net/categories/blablabla.html>Blablabla</a></li></ol></span><span class=article-meta-right><time datetime=2021-12-12T15:23:00.000+00:00 itemprop=datePublished>2021-12-12</time></span>
<span class=clearfix></span></div><div class=article-tags><ul class=article-tag-list><li class=article-tag-list-item><a href=//owent.net/tags/openssl.html>openssl</a></li><li class=article-tag-list-item><a href=//owent.net/tags/boringssl.html>boringssl</a></li><li class=article-tag-list-item><a href=//owent.net/tags/dh.html>dh</a></li><li class=article-tag-list-item><a href=//owent.net/tags/ecdh.html>ecdh</a></li><li class=article-tag-list-item><a href=//owent.net/tags/evp_pkey_set_bn_param.html>EVP_PKEY_set_bn_param</a></li></ul></div></footer></div><hr><nav id=article-nav><ul class=pagination><li class=page-item><a class=page-link id=article-nav-newer class=article-nav-link-wrap href=//owent.net/2022/2201.html>上一篇<strong>测试现代化硬件C++浮点数性能和一致性</strong></a></li><li class=page-item><a class=page-link id=article-nav-older class=article-nav-link-wrap href=//owent.net/2021/2109.html>下一篇<strong>近期cmake-toolset的一些适配问题</strong></a></li></ul></nav><hr><script src=https://utteranc.es/client.js repo=owent/blog-website issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></article></div></section></div><footer id=footer><div class=outer><div id=footer-info class="inner clearfix"><strong id=footer-left class="float-left float-start"><a rel=license href=https://github.com/owent/blog-hugo/blob/master/LICENSE.md><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png></a>
2024
owent
</strong><strong id=footer-right class="float-right float-end"><a href=https://github.com/owent/blog-hugo target=_blank>本站源码</a>,
发布者 <a href=https://gohugo.io/ target=_blank>Hugo</a>,
主题 <a href=https://github.com/owent/hugo-theme-distinctionpp target=_blank>distinctionpp</a>
</strong><span class=clearfix></span></div></div></footer></div><script type=text/javascript src=//unpkg.com/@popperjs/core@latest/dist/umd/popper.min.js crossorigin=anonymous></script><script type=text/javascript src=//unpkg.com/bootstrap@latest/dist/js/bootstrap.min.js crossorigin=anonymous></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/highlight.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/awk.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/bash.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/cpp.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/capnproto.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/cmake.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/d.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/diff.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/dockerfile.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/dos.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/erlang.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/go.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/less.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/llvm.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/lua.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/php.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/powershell.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/protobuf.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/python.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/profile.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/typescript.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/vim.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/rust.min.js></script><script type=text/javascript src=//unpkg.com/@highlightjs/cdn-assets@latest/languages/yaml.min.js></script><script type=text/javascript>jQuery(function(){jQuery("head").append('<link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@latest/styles/vs2015.min.css" />'),window.JSON?hljs.configure(JSON.parse('{"ignoreunescapedhtml":true,"languages":{},"tabreplace":"    ","throwunescapedhtml":false,"usebr":false}')):hljs.configure(evel('{"ignoreunescapedhtml":true,"languages":{},"tabreplace":"    ","throwunescapedhtml":false,"usebr":false}'));const e={};for(const t of hljs.listLanguages())e[t.toLowerCase()]=!0;jQuery("pre>code").each(function(e,t){try{if(t.className.match(/\bnohighlight\b|\bmermaid\b/i))return;const e=t.className.match(/language-([^\s]+)/i);if(e&&e.length>=2&&hljs.getLanguage(e[1]))hljs.highlightElement(t);else{const e=jQuery(t),n=hljs.highlightAuto(e.text(),hljs.listLanguages());n&&n.value&&(e.html(n.value),e.addClass("hljs"))}}catch(e){window.console&&console.log(e.toString()+`\r
Maybe can not detect the language`)}})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PQEY77BYG1"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PQEY77BYG1")}</script><script type=text/javascript src=//unpkg.com/katex@latest/dist/katex.min.js></script><script type=text/javascript src=//unpkg.com/katex@latest/dist/contrib/auto-render.min.js></script><script type=text/javascript>jQuery(function(){jQuery("head").append('<link rel="stylesheet" href="//unpkg.com/katex@latest/dist/katex.min.css" />'),renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"$",right:"$",display:!1}],throwOnError:!1,ignoredTags:["script","noscript","style","textarea","pre","code"]})})</script><script type=text/javascript src=//unpkg.com/chart.js@latest/dist/chart.umd.js></script><script type=module>
    import mermaid from "\/\/unpkg.com\/mermaid@latest\/dist\/mermaid.esm.min.mjs";
    const config = {
        theme: 'neutral',
        logLevel: 'fatal',
        securityLevel: 'loose', 
        startOnLoad: true,
        arrowMarkerAbsolute: false,
        

    };
    mermaid.initialize(config);
</script></div></body></html>