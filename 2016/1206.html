<!DOCTYPE html>
<html lang="zh-cn">

<head>
  
  
  <meta charset="utf-8" />
  <title>给客户端写得LRU缓存|I&#39;m OWenT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="canonical" href="//owent.net/2016/1206.html">
  <link href="//owent.net/index.xml" rel="alternate" type="application/rss+xml" title="I&#39;m OWenT" />
  
  <link rel="icon" href='../favicon.ico' />
  
  
  <link rel="stylesheet" href='//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.2.1/css/bootstrap.min.css' crossorigin="anonymous" />
  
  <link rel="stylesheet" href='//owent.net/css/style.css' />

  
  <script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js' crossorigin="anonymous"></script>
  
  
  
  <link rel="stylesheet" href='//owent.net/css/syntax.css' />
  
</head>
<body><div id="container"><div id="wrap">
<header id="header">
  <div id="banner"></div>
  <div id="header-outer">
    <div id="header-title">
      <h1 id="site-title">
        <a href="//owent.net" id="logo">I&#39;m OWenT</a>
      </h1>
      
      <h2 id="site-description">Challenge Everything</h2>
      
    </div>
    <div id="header-inner">
      <nav id="main-nav" class="navbar navbar-expand-md navbar-dark">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#main-nav-links" aria-controls="main-nav-links" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <a id="main-nav-brand" class="navbar-brand collapse" href="#">#</a>
        <div class="collapse navbar-collapse" id="main-nav-links">
          <ul class="navbar-nav mr-auto">
            
              
                <li class="nav-item"><a class="nav-link" href="../" title='Home'>Home</a></li>
              
                <li class="nav-item"><a class="nav-link" href="../archives.html" title='Archives'>Archives</a></li>
              
                <li class="nav-item"><a class="nav-link" href="../about.html" title='About'>About</a></li>
              
            
            <li class="nav-item"><a id="nav-rss-link" class="nav-link" href="//owent.net/index.xml" title='RSS订阅'>RSS订阅</a></li>
          </ul>
          
          <form class="form-inline" method="get" accept-charset="UTF-8" action='//www.bing.com/search'>
            <input type="hidden" name='q1' value='site:owent.net' />
            <input class="form-control" type="text" placeholder='搜索' name='q' />
            <button class="btn btn-outline-secondary my-2 my-sm-0" type="submit">搜索</button>
          </form>
          
        </div>
      </nav>
    </div>
  </div>
</header>
<div id="main"><section id="main-content">
<div id="post-content"><article id="post-015d6015774c0ac9015bbc44bd2cafdc" class="article-panel article article-type-post" itemscope itemprop="blogPost">
  <div class="article-panel-inner article-inner">
    <div class="article-inner">
      <header class="article-header"><h1 itemprop="name"><a class='article-title' href="//owent.net/2016/1206.html" target="_blank" itemprop="url">给客户端写得LRU缓存</a></h1></header><hr />
      <div id="toc" class="well toc m-3 p-1 pr-1 pt-1 pb-2 float-md-right"><nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#前言">前言</a></li>
<li><a href="#lru实现设计">LRU实现设计</a></li>
<li><a href="#客户端上的应用">客户端上的应用</a></li>
<li><a href="#服务器上的应用">服务器上的应用</a></li>
<li><a href="#代码实现">代码实现</a></li>
</ul></li>
</ul>
</nav></div><br />
      <div class="article-entry" itemprop="articleBody">

<!-- toc -->

<h2 id="前言">前言</h2>

<p>由于我们的客户端的元素和资源比较多，cocos框架的各种库质量参差不齐，导致了有些地方加载速度实在很慢。并且没有一个统一的内存管理机制导致了整个内存占用不太好控制。</p>

<p>同时手机的硬件环境实在是千差万别，在IOS上，由于CPU和IO比较好，很多东西重算代价倒不大。<br />
但是在Android上，CPU本来就偏弱，然后很多国产性价比机器，零件都缩水在IO设备上，还附加了各种用于节能和降低发热的降频策略，锁CPU策略。导致了很多数据重建的延迟比较高。<br />
然而我们很容易发现，大多数Android的机器的内存都非常高，动辄2-3GB。<br />
所以就希望说我们的应用能够最大化的利用内存作为缓存，在IOS上内存不够时重算，在Android上就拼命地用内存坐缓存，加载loading速度。</p>

<p>于是乎有了个写个LRU算法作为资源管理的想法。并且既然要做，就做得尽量简单、可复用，最好还能到时候服务器上也用。</p>

<h2 id="lru实现设计">LRU实现设计</h2>

<p>由于最主要还是由客户端的问题引起的，所以最先还是考虑客户端的需求。目标如下：</p>

<ol>
<li>首先这个管理器必须能够管理多种不同类型的资源（这是必须得，不然没存在的意义）<br /></li>
<li>其次需要在不同类型的设备上用，所以一个很重要的功能就是自适应，能够弹性得自动调整在不同设备上的阈值<br /></li>
<li>低性能消耗的LRU算法<br />
<br /></li>
</ol>

<p>为解决第一个问题，我们把LRU对象池分为两部分，<strong>LRU管理器</strong>和<strong>对象池</strong>。其中<strong>LRU管理器</strong>负责管理所管辖的多种不同类型对象的对象池，然后负责判定LRU算法的缓存和失效淘汰规则。而<strong>对象池</strong>中则实际负责保存对象缓存。</p>

<p>对第二个问题，考虑到在IOS上有专门的事件通知内存报警，但是在Android没有，所以为了简便起见，统一设置告警走类似IOS的报警作为LRU的主动GC操作。这样的话Android需要自己判定低内村并触发内存回收。<br />
关键在于回收的同时需要动态调整阈值，以适应当前的内存总量。目前的策略是单触发主动回收时，各项阈值减半，并大量回收资源。而push数量过多时触发一次资源回收，但是随之会将阈值的上限+1。总体上有点像TCP的拥塞算法。</p>

<p>最重要的就是LRU算法设计，为了减少LRU管理器的消耗，默认情况下对LRU资源池的操作都可以认为是O(1)的。</p>

<ol>
<li>每种<strong>对象池</strong>内部维护一个队列，记录着所有缓存的空闲对象。<br /></li>
<li><strong>LRU管理器</strong>内部维护一个队列，记录着各类对象的进入缓存池的顺序。<br /></li>
<li>每种<strong>对象池</strong>对饮一个*push*操作，一个*pull*操作。<br /></li>

<li><p>每一次*push*意味着一个对象进入<strong>对象池</strong>，把该对象推入队列首，同时分配一个push id，并记录到<strong>LRU管理器</strong>的push序列队列中。</p>

<blockquote>
<p><strong>LRU管理器</strong>的push序列队列只记录push id和<strong>对象池</strong>内部的缓存队列</p>
</blockquote></li>

<li><p>每一次*pull*意味着从<strong>对象池</strong>里取出一个对象，直接从队列首取出。这个操作和上面的一起组成了后进先出（LIFO）队列，即用来判定LRU的最近使用对象。</p></li>

<li><p>push id使用uint64_t基本可以认为单进程内不可能会重复（实际使用中会保留如此之多的push id，所以必定唯一）</p></li>

<li><p><strong>LRU管理器</strong>统计总对象数量和push序列队列长度，当总对象数量超出上限或push序列队列长度过长时触发被动GC</p></li>

<li><p><strong>LRU管理器</strong>提供接口触发主动GC</p></li>

<li><p>每次执行GC则是从<strong>push序列队列</strong>里取最前面的节点，如果该节点的<strong><em>push id</em></strong>和里面记录的<strong><em>缓存队列</em></strong>的队列尾的push id一致，则认为该节点有效，执行该对象的gc。否则就是已失效，直接跳过。</p>

<blockquote>
<p>因为存在一个对象被push，然后被pull出来，再被push进去的情况。这时候前一次的push序列记录已然已经失效，为了减少CPU消耗，pull的时候并不清理失效的push序列记录。<br />
但是无论何时被push进对象池，push id一定是唯一的，所以只要判定push id是否有效就可以了。</p>

<p>另外，由于是LRU算法，所以缓存队列里的队尾的必定是最早被push进队列的，而push序列也一定是按次序排序的，所以利用它们的这个特性可以实现O(1)复杂度的对象管理。因为每次push一定只伴随着一次pull或者一次gc。</p>
</blockquote></li>

<li><p>被动GC的阈值调整是指push过多，pull过少导致的缓存数量过多时调整最大上限。对应着<strong>push序列的最大上限</strong>和<strong>总对象数量上限</strong>。每次超出都+1，然后回收一个对象。</p></li>

<li><p>主动GC的阈值是指系统资源不足，需要主动由外部触发的缓存回收，这时候会把<strong>push序列的最大上限</strong>、<strong>总对象数量上限</strong>和<strong>总对象数量下限（即回收的时候保留的数量）</strong>调整为和当前序列数量/对象数量的平均值。然后回收的时候仅保留<strong>总对象数量下限</strong></p>

<blockquote>
<p>这一条和上一条配合使用，上一条会使缓存数量缓慢增加，这一条会使缓存数量大幅减少。这样，在高内存机器上就会很少触发主动GC，低内存机器上多触发主动GC。<br />
目前使用这两种算法来实现各个机型上的动态缓存数量。</p>
</blockquote></li>

<li><p>在实际使用过程中加入了超时机制，即即便内存很大，超过一定时间的push序列也会触发超时回收。</p></li>

<li><p>在实际使用过程中加入了自动调整各类上下限阈值的边界，因为在客户端场景里，有时候触发主动GC之后，有些资源会过一会再回收资源或在下一个关键点再回收。这会导致短时间内频繁触发主动GC。这会使动态调整的限制很快被调整到0值。以防这种情况再出现，加入了一个边界限制。</p></li>
</ol>

<h2 id="客户端上的应用">客户端上的应用</h2>

<p>实际缓存池的实际使用过程中还是碰到了一些问题的。首先是cocos的很多组件本身有缓存机制，比如dragonbones和spine，还有sprite对贴图文件的缓存，对于这种对象实测缓存的影响不是特别大。</p>

<p>影响特别大得就是cocostudio创建的对象，我们里面实施了两层缓存。第一层是把csb文件缓存进来，这样可以减少IO操作，但是后来发现根据csb文件创建cocostudio节点反而花费了更多的时间（2/3的时间耗在这里）。<br />
所以后来不得不对cocostudio创建的节点做缓存。然而如果是一开始就使用这个缓存的话就比较容易发现问题，我们中途开始切入这个缓存的话就发现。我们的很多UI模块代码并没有特别去重置CCNode，而是依赖析构作为资源回收和重置。<br />
这导致了很多地方如果回收作为缓存的话，这次改动的地方，就变成下次读入以后的默认值。包括上一次添加到ListView里的节点都还在。</p>

<p>为了解决这个问题，我们不得不改动了cocos的源代码，对CCNode里一些公用的属性，比如children、position、anchor等属性做了快照。然后下次pull完以后恢复到快照。本来也想直接使用cocos的clone函数，无奈cocos的clone接口实现不全最后没有使用。<br />
而cocostudio创建的一些子类的ui对象比如ListView、ImageView等等里那些不属于CCNode的属性，就要求使用前手动reset，因为如果每个子类都去加缓存的话对cocos的改动有点大，怕以后不好merge。</p>

<p>最后就是实际释放缓存的过程中，有些数据是在切换场景的时候释放的，这时候很多对资源的引用都会清空，不会再次使用。<br />
比如sprite的贴图，清理的时候如果场景里还有引用到的地方，是不会清除的。<br />
再比如dragonbones的骨骼和贴图，dragonbones自己有一层缓存和引用记录，但是它做得不好，在缓存清理的时候不通知被引用的Node，然后会导致被引用的Node在渲染时崩溃。所以清除dragonbones自身的缓存的同时还必须清理所有已有的对象。<br />
而且特别是dragonbones和spine，即便目前没有使用在一场战斗中十有八九马上也会用到。战斗中卡一下的体验是非常不好的。所以对这些资源都会延后释放。</p>

<p>延后释放也会碰到一个问题，就是可能短时间内内存并没有被清理出来，然后会频繁调用主动GC。于是就有了上面第12条提到的限制。但是特别是IOS既然到了内存告警，最好先释放一部分出来。以备后用。<br />
所以我们的缓存回收里加了一些分级，有些对象常规内存回收不做，紧急内存（IOS内存告警）回收会尽量释放一些应该不会再被引用到的资源。</p>

<h2 id="服务器上的应用">服务器上的应用</h2>

<p>暂时还未实施，但是这样的LRU算法设计也考虑了服务器上可能可以使用的场景。比如聊天服务器按活跃度来缓存玩家或者频道的聊天数据，淘汰冷数据。</p>

<p>另外在服务器端虽然不用太多地考虑内存回收问题，但是可以利用这个算法管理器的过期机制来提供定期保存的功能。甚至实现定期脏数据保存的功能。</p>

<blockquote>
<p>**定期保存: ** 每个对象只push一次，在gc时保存并重新push进pool</p>

<p>**定期脏数据保存: ** 每个对象在写脏时先pull再push一次，在gc时保存</p>

<p>并且这些功能都可以利用lru管理器的各类上限来实现过载保护</p>
</blockquote>

<h2 id="代码实现">代码实现</h2>

<p>以上的代码位于： <a href="https://github.com/owent-utils/c-cpp/blob/master/include/MemPool/lru_object_pool.h" target="_blank">https://github.com/owent-utils/c-cpp/blob/master/include/MemPool/lru_object_pool.h</a><br />
单元测试见： <a href="https://github.com/owent-utils/c-cpp/blob/master/test/case/LRUObjectPoolTest.cpp" target="_blank">https://github.com/owent-utils/c-cpp/blob/master/test/case/LRUObjectPoolTest.cpp</a></p>

<blockquote>
<p>Written with <a href="https://stackedit.io/" target="_blank">StackEdit</a>.</p>
</blockquote>
</div>
      <hr />
      <footer class="article-footer">
        <div class="article-panel-footer article-meta article-footer">
          <span class="article-meta-left">
  <ol>
    
    <li><a href='//owent.net/categories/article.html'>Article</a></li>
    
    <li><a href='//owent.net/categories/work.html'>Work</a></li>
    
  </ol>
</span>
          <span class="article-meta-right"><time datetime='2016-01-04T20:23:18.000&#43;00:00' itemprop="datePublished">2016-01-04</time></span>
          <span class="clearfix"></span>
        </div>
        
        
<div class="article-tags">
  <ul class="article-tag-list">
    
    <li class="article-tag-list-item"><a href='//owent.net/tags/algorithm.html'>algorithm</a></li>
    
    <li class="article-tag-list-item"><a href='//owent.net/tags/%E7%AE%97%E6%B3%95.html'>算法</a></li>
    
  </ul>
</div>

      </footer>
    </div>
    
<hr />
<nav id="article-nav">
  <ul class="pagination">
  
    <li class="page-item">
      <a class="page-link" id="article-nav-newer" class="article-nav-link-wrap" href='//owent.net/2016/1209.html'>
        上一篇<strong>博客文章和文档迁移到gitbook</strong>
      </a>
    </li>
  
  
    <li class="page-item">
      <a class="page-link" id="article-nav-older" class="article-nav-link-wrap" href='//owent.net/2015/1203.html'>
        下一篇<strong>近期活动比较零散</strong>
      </a>
    </li>
  
  </ul>
</nav>

    
<hr />
<section id="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_config = function () {

this.page.identifier = '1206';

};
(function() { 
var d = document, s = d.createElement('script');
s.src = 'https://owent.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


  </div>
</article></div>
</section></div>
<footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      <strong id="footer-left">
        &copy; 2019
        OWenT
        
        
      </strong>
      <strong id="footer-right">
        
        
        <a href="https://github.com/owent/blog-hugo" target="_blank">本站源码</a>,
        
        发布者 <a href="https://gohugo.io/" target="_blank">Hugo</a>,
        主题 <a href="https://github.com/owt5008137/hugo-theme-distinctionpp" target="_blank">distinctionpp</a>
      </strong>
      <span class="clearfix"></span>
    </div>
  </div>
</footer>
</div>













  
  <script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js' crossorigin="anonymous"></script>
  
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.2.1/js/bootstrap.min.js' crossorigin="anonymous"></script>



<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js'></script>

<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/bash.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/cpp.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/capnproto.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/cmake.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/d.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/diff.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/dos.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/erlang.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/go.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/less.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/lua.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/php.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/powershell.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/protobuf.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/profile.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/typescript.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/vim.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/rust.min.js'></script>
<script type="text/javascript">
jQuery(function (){
    jQuery("head").append('<link rel="stylesheet" href="\/\/cdnjs.cloudflare.com\/ajax\/libs\/highlight.js\/9.15.6\/styles\/vs2015.min.css" />');
    if (window.JSON) {
        hljs.configure(JSON.parse("{\"languages\":{},\"tabreplace\":\"    \",\"usebr\":false}"));
    } else {
        hljs.configure(evel("{\"languages\":{},\"tabreplace\":\"    \",\"usebr\":false}"));
    }
    jQuery('pre\x3ecode').each(function(i, block) {
        try {
            hljs.highlightBlock(block);
        } catch (e) {
            if (window.console) {
                console.log(e.toString() + "\r\nMaybe can not detect the language");
            }
        }
    });
});
</script>




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-19298704-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-19298704-1');
</script>




<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js'></script>
<script type="text/javascript">
jQuery(function(){
    jQuery("head").append('<link rel="stylesheet" href="\/\/cdnjs.cloudflare.com\/ajax\/libs\/KaTeX\/0.10.0\/katex.min.css" />');
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "\\(", right: "\\)", display: false},
            {left: "`$", right: "$`", display: false}
        ],
        ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    });
});
</script>


<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js'></script>


<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/mermaid/8.0.0/mermaid.min.js'></script>

</div>
</body></html>